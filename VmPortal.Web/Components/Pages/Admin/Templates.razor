@page "/admin/templates"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = VmPortal.Domain.Security.SecurityConstants.Policies.Admin)]
@inherits SecureComponentBase
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Application.Security
@inject VmPortalDbContext Db
@inject IInputSanitizer Sanitizer
@using System.Linq
@using VmPortal.Application.Proxmox
@inject Microsoft.Extensions.Options.IOptions<ProxmoxTagOptions> TagOptions
@using System.Text.RegularExpressions

@inject IProxmoxClient Proxmox

<PageTitle>VM Templates</PageTitle>

<h1 class="h3 mb-3">VM Templates</h1>

@if (_loading)
{
    <div class="d-flex justify-content-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">Defined Templates</h5>
                    <span class="text-muted small">Total: @_templates.Count</span>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Node</th>
                                <th>Template VMID</th>
                                <th>Defaults</th>
                                <th>Limits</th>
                                <th>Template Tag</th>
                                <th>Active</th>
                                <th>Manage</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (VmTemplate template in _templates)
                            {
                                bool isEditing = _editingTemplateId.HasValue && _editingTemplateId.Value == template.Id;

                                <tr class="@(isEditing ? "table-primary" : string.Empty)">
                                    <td>@Sanitizer.SanitizeForDisplay(template.Name)</td>
                                    <td>@Sanitizer.SanitizeForDisplay(template.Node)</td>
                                    <td>@template.TemplateVmId</td>
                                    <td>
                                        <small>
                                            CPU: @template.DefaultCpuCores,
                                            RAM: @template.DefaultMemoryMiB MiB,
                                            Disk: @template.DefaultDiskGiB GiB
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            CPU max: @(template.MaxCpuCores?.ToString() ?? "—"),
                                            RAM max: @(template.MaxMemoryMiB?.ToString() ?? "—") MiB,
                                            Disk max: @(template.MaxDiskGiB?.ToString() ?? "—") GiB
                                        </small>
                                    </td>
                                    <td>
                                        <small>
                                            @(string.IsNullOrWhiteSpace(template.TemplateTagName)
                                                                                ? "—"
                                                                                : template.TemplateTagName)
                                        </small>
                                    </td>
                                    <td>
                                        @if (template.IsActive)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                    <td class="text-nowrap">
                                        <button class="btn btn-sm btn-outline-primary me-1"
                                                @onclick="() => EditTemplate(template)">
                                            <i class="fas fa-edit me-1"></i> Edit
                                        </button>
                                    </td>
                                </tr>
                            }

                            @if (_templates.Count == 0)
                            {
                                <tr>
                                    <td colspan="8" class="text-center text-muted py-3">
                                        No templates defined yet.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">@(_editingTemplateId.HasValue ? "Edit Template" : "Add Template")</h5>
                    @if (_editingTemplateId.HasValue)
                    {
                        <button class="btn btn-sm btn-outline-secondary"
                                @onclick="ResetForm">
                            <i class="fas fa-plus me-1"></i> New
                        </button>
                    }
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(_validationError))
                    {
                        <div class="alert alert-warning py-2 mb-3">
                            @_validationError
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input class="form-control"
                               @bind="_name"
                               @bind:event="oninput" />
                        <div class="form-text">
                            Example: "Sitecore VM Dummy" or "Ubuntu 24.04 Template".
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Node</label>
                        <input class="form-control"
                               @bind="_node"
                               @bind:event="oninput" />
                        <div class="form-text">
                            Proxmox node name, e.g. "pve" or "pve1.local".
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Template VMID</label>
                        <input class="form-control"
                               type="number"
                               @bind="_templateVmId"
                               @bind:event="oninput" />
                        <div class="form-text small">
                            Proxmox VMID of the source template used for cloning.
                        </div>
                    </div>

                    <div class="mb-2">
                        <span class="text-muted small">Defaults</span>
                    </div>
                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">CPU</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_cpu"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">RAM (MiB)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_memoryMiB"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">Disk (GiB)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_diskGiB"
                                   @bind:event="oninput" />
                        </div>
                    </div>

                    <div class="mb-2">
                        <span class="text-muted small">Per-template Limits (optional)</span>
                    </div>
                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Max CPU</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_maxCpu"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">Max RAM (MiB)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_maxMemoryMiB"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">Max Disk (GiB)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_maxDiskGiB"
                                   @bind:event="oninput" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Template Tag (optional)</label>
                        <input class="form-control"
                               @bind="_templateTagName"
                               @bind:event="oninput" />
                        <div class="form-text small">
                            Proxmox tag to apply to VMs cloned from this template (e.g. <code>sitecore</code>, <code>ubuntu-24</code>).
                            Only letters, numbers, and <code>_+.-:</code>, no spaces.
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control"
                                  rows="3"
                                  @bind="_description"
                                  @bind:event="oninput"></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input"
                               type="checkbox"
                               @bind="_isActive" />
                        <label class="form-check-label">Active</label>
                    </div>

                    <button class="btn btn-primary w-100"
                            @onclick="SaveTemplateAsync"
                            disabled="@_saving">
                        @if (_saving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        @(_editingTemplateId.HasValue ? "Save Changes" : "Create Template")
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<VmTemplate> _templates = new List<VmTemplate>();
    private bool _loading = true;
    private bool _saving = false;
    private string? _validationError;

    private Guid? _editingTemplateId;
    private string? _templateTagName;
    private ProxmoxTagOptions _tagOptions = new ProxmoxTagOptions();

    private string _name = string.Empty;
    private string _node = string.Empty;
    private int _templateVmId;
    private int _cpu = 2;
    private int _memoryMiB = 2048;
    private int _diskGiB = 20;

    private int? _maxCpu;
    private int? _maxMemoryMiB;
    private int? _maxDiskGiB;

    private string? _description;
    private bool _isActive = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _tagOptions = TagOptions.Value;
        await LoadTemplatesAsync();
    }

    private async Task LoadTemplatesAsync()
    {
        try
        {
            _templates = await Db.VmTemplates
                .OrderBy(t => t.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load VM templates");
            await LogSecurityEventAsync("AdminTemplateLoadFailed", ex.Message, "Error");
        }
        finally
        {
            _loading = false;
        }
    }

    private void EditTemplate(VmTemplate template)
    {
        _editingTemplateId = template.Id;

        _name = template.Name;
        _node = template.Node;
        _templateVmId = template.TemplateVmId;
        _cpu = template.DefaultCpuCores;
        _memoryMiB = template.DefaultMemoryMiB;
        _diskGiB = template.DefaultDiskGiB;
        _maxCpu = template.MaxCpuCores;
        _maxMemoryMiB = template.MaxMemoryMiB;
        _maxDiskGiB = template.MaxDiskGiB;
        _description = template.Description;
        _isActive = template.IsActive;
        _templateTagName = template.TemplateTagName;
        _validationError = null;
    }

    private void ResetForm()
    {
        _editingTemplateId = null;

        _name = string.Empty;
        _node = string.Empty;
        _templateVmId = 0;
        _cpu = 2;
        _memoryMiB = 2048;
        _diskGiB = 20;
        _maxCpu = null;
        _maxMemoryMiB = null;
        _maxDiskGiB = null;
        _description = null;
        _isActive = true;
        _templateTagName = null;
        _validationError = null;
    }

    private async Task SaveTemplateAsync()
    {
        _saving = true;
        _validationError = null;

        try
        {
            string name = (_name ?? string.Empty).Trim();
            string node = (_node ?? string.Empty).Trim();

            Logger.LogInformation("Template form submit: Name='{Name}', Node='{Node}', TemplateVmId={TemplateVmId}, EditingId={EditingId}",
                name, node, _templateVmId, _editingTemplateId);

            if (string.IsNullOrEmpty(name))
            {
                _validationError = "Name is required.";
                await LogSecurityEventAsync("AdminTemplateValidationFailed", "Name is empty", "Warning");
                _saving = false;
                return;
            }

            if (string.IsNullOrEmpty(node))
            {
                _validationError = "Node is required.";
                await LogSecurityEventAsync("AdminTemplateValidationFailed", "Node is empty", "Warning");
                _saving = false;
                return;
            }

            if (_templateVmId <= 0)
            {
                _validationError = "Template VMID must be a positive number.";
                await LogSecurityEventAsync("AdminTemplateValidationFailed", "Invalid template VMID", "Warning");
                _saving = false;
                return;
            }

            if (_cpu <= 0)
            {
                _validationError = "Default CPU must be positive.";
                _saving = false;
                return;
            }

            if (_memoryMiB <= 0)
            {
                _validationError = "Default RAM must be positive.";
                _saving = false;
                return;
            }

            if (_diskGiB <= 0)
            {
                _validationError = "Default Disk must be positive.";
                _saving = false;
                return;
            }

            // Max validations (optional)
            if (_maxCpu.HasValue && _maxCpu.Value <= 0)
            {
                _validationError = "Max CPU must be positive when set.";
                _saving = false;
                return;
            }

            if (_maxMemoryMiB.HasValue && _maxMemoryMiB.Value <= 0)
            {
                _validationError = "Max RAM must be positive when set.";
                _saving = false;
                return;
            }

            if (_maxDiskGiB.HasValue && _maxDiskGiB.Value <= 0)
            {
                _validationError = "Max Disk must be positive when set.";
                _saving = false;
                return;
            }

            if (_maxCpu.HasValue && _cpu > _maxCpu.Value)
            {
                _validationError = "Default CPU cannot exceed Max CPU.";
                _saving = false;
                return;
            }

            if (_maxMemoryMiB.HasValue && _memoryMiB > _maxMemoryMiB.Value)
            {
                _validationError = "Default RAM cannot exceed Max RAM.";
                _saving = false;
                return;
            }

            if (_maxDiskGiB.HasValue && _diskGiB > _maxDiskGiB.Value)
            {
                _validationError = "Default Disk cannot exceed Max Disk.";
                _saving = false;
                return;
            }

            string? normalizedTemplateTagName = null;

            if (!string.IsNullOrWhiteSpace(_templateTagName))
            {
                string rawTag = _templateTagName.Trim();

                // Allowed characters: letters, numbers, _+.-:, no spaces
                Regex tagRegex = new Regex("^[A-Za-z0-9_+\\.\\-:]+$");

                if (!tagRegex.IsMatch(rawTag))
                {
                    _validationError = "Template tag is invalid. Only letters, numbers, and _+.-: are allowed, no spaces.";
                    _saving = false;
                    return;
                }

                // Strip prefix if the admin typed it (to avoid double-prefix in DB)
                string? prefix = _tagOptions.TemplateNameTagPrefix;
                if (!string.IsNullOrEmpty(prefix) &&
                    rawTag.StartsWith(prefix, StringComparison.OrdinalIgnoreCase))
                {
                    rawTag = rawTag.Substring(prefix.Length);
                }

                // Prevent using system tags directly as the template tag
                string? managedTag = _tagOptions.ManagedVmTag;
                if (!string.IsNullOrEmpty(managedTag) &&
                    rawTag.Equals(managedTag, StringComparison.OrdinalIgnoreCase))
                {
                    _validationError = "This tag is reserved for system use.";
                    _saving = false;
                    return;
                }

                string? systemTemplateTag = _tagOptions.TemplateTag;
                if (!string.IsNullOrEmpty(systemTemplateTag) &&
                    rawTag.Equals(systemTemplateTag, StringComparison.OrdinalIgnoreCase))
                {
                    _validationError = "This tag is reserved for system use.";
                    _saving = false;
                    return;
                }

                // Normalize for consistency (you can keep original casing if you prefer)
                normalizedTemplateTagName = rawTag.ToLowerInvariant();
            }

            if (_editingTemplateId.HasValue)
            {
                VmTemplate? existing = await Db.VmTemplates.FirstOrDefaultAsync(t => t.Id == _editingTemplateId.Value);
                if (existing == null)
                {
                    _validationError = "The template you are editing no longer exists.";
                    _saving = false;
                    await LoadTemplatesAsync();
                    return;
                }

                existing.Name = name;
                existing.Node = node;
                existing.TemplateVmId = _templateVmId;
                existing.DefaultCpuCores = _cpu;
                existing.DefaultMemoryMiB = _memoryMiB;
                existing.DefaultDiskGiB = _diskGiB;
                existing.MaxCpuCores = _maxCpu;
                existing.MaxMemoryMiB = _maxMemoryMiB;
                existing.MaxDiskGiB = _maxDiskGiB;
                existing.TemplateTagName = normalizedTemplateTagName;
                existing.Description = _description;
                existing.IsActive = _isActive;

                await Db.SaveChangesAsync();

                try
                {
                    IEnumerable<string> tags = BuildTemplateVmTags(existing);
                    await Proxmox.SetVmTagsAsync(existing.Node, existing.TemplateVmId, tags, default);
                }
                catch (Exception tagEx)
                {
                    Logger.LogError(tagEx, "Failed to apply tags to template VM {VmId} on node {Node}",
                        existing.TemplateVmId,
                        existing.Node);
                }

                await LogSecurityEventAsync("AdminTemplateUpdated",
                    $"Template: {existing.Name} ({existing.TemplateVmId})", "Information");

                await PropagateTemplateLimitsToVmsAsync(existing);
                await PropagateTemplateTagsToVmsAsync(existing);

            }
            else
            {
                // Create new template
                VmTemplate template = new VmTemplate
                {
                    Id = Guid.NewGuid(),
                    Name = name,
                    Node = node,
                    TemplateVmId = _templateVmId,
                    DefaultCpuCores = _cpu,
                    DefaultMemoryMiB = _memoryMiB,
                    DefaultDiskGiB = _diskGiB,
                    MaxCpuCores = _maxCpu,
                    MaxMemoryMiB = _maxMemoryMiB,
                    MaxDiskGiB = _maxDiskGiB,
                    TemplateTagName = normalizedTemplateTagName,
                    Description = _description,
                    IsActive = _isActive,
                    CreatedAt = DateTimeOffset.UtcNow
                };

                Db.VmTemplates.Add(template);
                await Db.SaveChangesAsync();

                try
                {
                    IEnumerable<string> tags = BuildTemplateVmTags(template);
                    await Proxmox.SetVmTagsAsync(template.Node, template.TemplateVmId, tags, default);
                }
                catch (Exception tagEx)
                {
                    Logger.LogError(tagEx, "Failed to apply tags to template VM {VmId} on node {Node}",
                        template.TemplateVmId,
                        template.Node);
                }

                await LogSecurityEventAsync("AdminTemplateCreated",
                    $"Template: {template.Name} ({template.TemplateVmId})", "Information");
            }

            // Reload list and reset form
            await LoadTemplatesAsync();
            ResetForm();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to save VM template");
            await LogSecurityEventAsync("AdminTemplateSaveFailed", ex.Message, "Error");
        }
        finally
        {
            _saving = false;
        }
    }


    private async Task PropagateTemplateLimitsToVmsAsync(VmTemplate template)
    {
        // Update all VMs cloned from this template (same TemplateVmId and Node)
        List<Vm> vms = await Db.Vms
            .Where(v => v.TemplateVmId == template.TemplateVmId && v.Node == template.Node)
            .ToListAsync();

        foreach (Vm vm in vms)
        {
            vm.MaxCpuCores = template.MaxCpuCores;
            vm.MaxMemoryMiB = template.MaxMemoryMiB;
            vm.MaxDiskGiB = template.MaxDiskGiB;
        }

        await Db.SaveChangesAsync();

        await LogSecurityEventAsync(
            "AdminTemplateLimitsPropagated",
            $"Template: {Sanitizer.SanitizeForLog(template.Name)} ({template.TemplateVmId}), VMs affected: {vms.Count}",
            "Information");
    }

    private async Task PropagateTemplateTagsToVmsAsync(VmTemplate template)
    {
        // All VMs cloned from this template on the same node
        List<Vm> vms = await Db.Vms
            .Where(v => v.TemplateVmId == template.TemplateVmId && v.Node == template.Node && !v.IsDeleted)
            .ToListAsync();

        if (vms.Count == 0)
        {
            return;
        }

        Int32 updatedCount = 0;

        // Build the desired tags for child VMs (same as clone-time tags)
        List<String> desiredTags = new List<String>();

        if (!String.IsNullOrWhiteSpace(_tagOptions.ManagedVmTag))
        {
            desiredTags.Add(_tagOptions.ManagedVmTag);
        }

        if (!String.IsNullOrWhiteSpace(template.TemplateTagName) &&
            !String.IsNullOrWhiteSpace(_tagOptions.TemplateNameTagPrefix))
        {
            String templateNameTag = _tagOptions.TemplateNameTagPrefix + template.TemplateTagName;
            desiredTags.Add(templateNameTag);
        }

        foreach (Vm vm in vms)
        {
            try
            {
                await Proxmox.SetVmTagsAsync(vm.Node, vm.VmId, desiredTags, default);
                updatedCount++;
            }
            catch (Exception ex)
            {
                Logger.LogError(
                    ex,
                    "Failed to propagate template tags to VM {VmId} on node {Node} for template {TemplateVmId}",
                    vm.VmId,
                    vm.Node,
                    template.TemplateVmId);
            }
        }

        await LogSecurityEventAsync(
            "AdminTemplateTagsPropagated",
            $"Template: {Sanitizer.SanitizeForLog(template.Name)} ({template.TemplateVmId}), VMs updated: {updatedCount}",
            "Information");
    }

    private IEnumerable<string> BuildTemplateVmTags(VmTemplate template)
    {
        HashSet<string> tags = new HashSet<string>(StringComparer.OrdinalIgnoreCase);

        if (!string.IsNullOrWhiteSpace(_tagOptions.ManagedVmTag))
        {
            tags.Add(_tagOptions.ManagedVmTag);
        }

        if (!string.IsNullOrWhiteSpace(_tagOptions.TemplateTag))
        {
            tags.Add(_tagOptions.TemplateTag);
        }

        if (!string.IsNullOrWhiteSpace(template.TemplateTagName) &&
            !string.IsNullOrWhiteSpace(_tagOptions.TemplateNameTagPrefix))
        {
            string tmplTag = _tagOptions.TemplateNameTagPrefix + template.TemplateTagName;
            tags.Add(tmplTag);
        }

        return tags;
    }
    
}
