@page "/admin/templates"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = VmPortal.Domain.Security.SecurityConstants.Policies.Admin)]
@inherits SecureComponentBase
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Application.Security
@inject VmPortalDbContext Db
@inject IInputSanitizer Sanitizer

<PageTitle>VM Templates</PageTitle>

<h1 class="h3 mb-3">VM Templates</h1>

@if (_loading)
{
    <div class="d-flex justify-content-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Defined Templates</h5>
                </div>
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr>
                                <th>Name</th>
                                <th>Node</th>
                                <th>Template VMID</th>
                                <th>Defaults</th>
                                <th>Limits</th>
                                <th>Active</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (VmTemplate template in _templates)
                            {
                                <tr>
                                    <td>@Sanitizer.SanitizeForDisplay(template.Name)</td>
                                    <td>@Sanitizer.SanitizeForDisplay(template.Node)</td>
                                    <td>@template.TemplateVmId</td>
                                    <td>
                                        <small>
                                            CPU: @template.DefaultCpuCores,
                                            RAM: @template.DefaultMemoryMiB MiB,
                                            Disk: @template.DefaultDiskGiB GiB
                                        </small>
                                    </td>
                                    <td>
                                        <small class="text-muted">
                                            CPU max: @(template.MaxCpuCores?.ToString() ?? "—"),
                                            RAM max: @(template.MaxMemoryMiB?.ToString() ?? "—") MiB,
                                            Disk max: @(template.MaxDiskGiB?.ToString() ?? "—") GiB
                                        </small>
                                    </td>
                                    <td>
                                        @if (template.IsActive)
                                        {
                                            <span class="badge bg-success">Active</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">Inactive</span>
                                        }
                                    </td>
                                </tr>
                            }

                            @if (_templates.Count == 0)
                            {
                                <tr>
                                    <td colspan="6" class="text-center text-muted py-3">
                                        No templates defined yet.
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="col-lg-4">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0">Add Template</h5>
                </div>
                <div class="card-body">
                    @if (!string.IsNullOrEmpty(_validationError))
                    {
                        <div class="alert alert-warning py-2 mb-3">
                            @_validationError
                        </div>
                    }

                    <div class="mb-3">
                        <label class="form-label">Name</label>
                        <input class="form-control"
                               @bind="_name"
                               @bind:event="oninput" />
                        <div class="form-text">
                            Example: "Sitecore VM Dummy" or "Ubuntu 24.04 Template".
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Node</label>
                        <input class="form-control"
                               @bind="_node"
                               @bind:event="oninput" />
                        <div class="form-text">
                            Proxmox node name, e.g. "pve" or "pve1.local".
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Template VMID</label>
                        <input class="form-control"
                               type="number"
                               @bind="_templateVmId"
                               @bind:event="oninput" />
                    </div>

                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Default CPU</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_cpu"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">Default RAM (MiB)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_memoryMiB"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">Default Disk (GiB)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_diskGiB"
                                   @bind:event="oninput" />
                        </div>
                    </div>

                    <div class="row mb-3">
                        <div class="col-4">
                            <label class="form-label">Max CPU (opt.)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_maxCpu"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">Max RAM (MiB, opt.)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_maxMemoryMiB"
                                   @bind:event="oninput" />
                        </div>
                        <div class="col-4">
                            <label class="form-label">Max Disk (GiB, opt.)</label>
                            <input class="form-control"
                                   type="number"
                                   @bind="_maxDiskGiB"
                                   @bind:event="oninput" />
                        </div>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Description</label>
                        <textarea class="form-control"
                                  rows="3"
                                  @bind="_description"
                                  @bind:event="oninput"></textarea>
                    </div>

                    <div class="form-check mb-3">
                        <input class="form-check-input"
                               type="checkbox"
                               @bind="_isActive" />
                        <label class="form-check-label">Active</label>
                    </div>

                    <button class="btn btn-primary w-100"
                            @onclick="CreateTemplateAsync"
                            disabled="@_saving">
                        @if (_saving)
                        {
                            <span class="spinner-border spinner-border-sm me-2"></span>
                        }
                        Save Template
                    </button>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private List<VmTemplate> _templates = new List<VmTemplate>();
    private bool _loading = true;
    private bool _saving = false;
    private string? _validationError;

    private string _name = string.Empty;
    private string _node = string.Empty;
    private int _templateVmId;
    private int _cpu = 2;
    private int _memoryMiB = 2048;
    private int _diskGiB = 20;

    private int? _maxCpu;
    private int? _maxMemoryMiB;
    private int? _maxDiskGiB;

    private string? _description;
    private bool _isActive = true;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadTemplatesAsync();
    }

    private async Task LoadTemplatesAsync()
    {
        try
        {
            _templates = await Db.VmTemplates
                .OrderBy(t => t.Name)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load VM templates");
            await LogSecurityEventAsync("AdminTemplateLoadFailed", ex.Message, "Error");
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CreateTemplateAsync()
    {
        _saving = true;
        _validationError = null;

        try
        {
            string name = (_name ?? string.Empty).Trim();
            string node = (_node ?? string.Empty).Trim();

            Logger.LogInformation("Template form submit: Name='{Name}', Node='{Node}', TemplateVmId={TemplateVmId}",
                name, node, _templateVmId);

            if (string.IsNullOrEmpty(name))
            {
                _validationError = "Name is required.";
                await LogSecurityEventAsync("AdminTemplateValidationFailed", "Name is empty", "Warning");
                _saving = false;
                return;
            }

            if (string.IsNullOrEmpty(node))
            {
                _validationError = "Node is required.";
                await LogSecurityEventAsync("AdminTemplateValidationFailed", "Node is empty", "Warning");
                _saving = false;
                return;
            }

            if (_templateVmId <= 0)
            {
                _validationError = "Template VMID must be a positive number.";
                await LogSecurityEventAsync("AdminTemplateValidationFailed", "Invalid template VMID", "Warning");
                _saving = false;
                return;
            }

            if (_cpu <= 0)
            {
                _validationError = "Default CPU must be positive.";
                _saving = false;
                return;
            }

            if (_memoryMiB <= 0)
            {
                _validationError = "Default RAM must be positive.";
                _saving = false;
                return;
            }

            if (_diskGiB <= 0)
            {
                _validationError = "Default Disk must be positive.";
                _saving = false;
                return;
            }

            // Max validations (optional)
            if (_maxCpu.HasValue && _maxCpu.Value <= 0)
            {
                _validationError = "Max CPU must be positive when set.";
                _saving = false;
                return;
            }

            if (_maxMemoryMiB.HasValue && _maxMemoryMiB.Value <= 0)
            {
                _validationError = "Max RAM must be positive when set.";
                _saving = false;
                return;
            }

            if (_maxDiskGiB.HasValue && _maxDiskGiB.Value <= 0)
            {
                _validationError = "Max Disk must be positive when set.";
                _saving = false;
                return;
            }

            if (_maxCpu.HasValue && _cpu > _maxCpu.Value)
            {
                _validationError = "Default CPU cannot exceed Max CPU.";
                _saving = false;
                return;
            }

            if (_maxMemoryMiB.HasValue && _memoryMiB > _maxMemoryMiB.Value)
            {
                _validationError = "Default RAM cannot exceed Max RAM.";
                _saving = false;
                return;
            }

            if (_maxDiskGiB.HasValue && _diskGiB > _maxDiskGiB.Value)
            {
                _validationError = "Default Disk cannot exceed Max Disk.";
                _saving = false;
                return;
            }

            VmTemplate template = new VmTemplate
            {
                Id = Guid.NewGuid(),
                Name = name,
                Node = node,
                TemplateVmId = _templateVmId,
                DefaultCpuCores = _cpu,
                DefaultMemoryMiB = _memoryMiB,
                DefaultDiskGiB = _diskGiB,
                MaxCpuCores = _maxCpu,
                MaxMemoryMiB = _maxMemoryMiB,
                MaxDiskGiB = _maxDiskGiB,
                Description = _description,
                IsActive = _isActive,
                CreatedAt = DateTimeOffset.UtcNow
            };

            Db.VmTemplates.Add(template);
            await Db.SaveChangesAsync();

            await LogSecurityEventAsync("AdminTemplateCreated",
                $"Template: {template.Name} ({template.TemplateVmId})", "Information");

            // Reset form
            _name = string.Empty;
            _node = string.Empty;
            _templateVmId = 0;
            _cpu = 2;
            _memoryMiB = 2048;
            _diskGiB = 20;
            _maxCpu = null;
            _maxMemoryMiB = null;
            _maxDiskGiB = null;
            _description = null;
            _isActive = true;
            _validationError = null;

            await LoadTemplatesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create VM template");
            await LogSecurityEventAsync("AdminTemplateCreateFailed", ex.Message, "Error");
        }
        finally
        {
            _saving = false;
        }
    }
}
