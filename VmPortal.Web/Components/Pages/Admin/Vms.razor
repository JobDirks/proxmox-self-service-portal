@page "/admin/vms"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = VmPortal.Domain.Security.SecurityConstants.Policies.Admin)]
@inherits SecureComponentBase
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Domain.Users
@using VmPortal.Application.Proxmox
@using VmPortal.Application.Security
@inject VmPortalDbContext Db
@inject IProxmoxClient Proxmox
@inject IRateLimitingService RateLimit
@inject IInputSanitizer Sanitizer

<PageTitle>VM Administration</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1><i class="fas fa-server"></i> VM Administration</h1>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary"
                @onclick="RefreshAllVmsAsync"
                disabled="@( _operationInProgress ? "disabled" : null)">
            <i class="fas fa-sync-alt"></i> Refresh All
        </button>
    </div>
</div>

@if (_rateLimitCooldown.HasValue)
{
    <div class="alert alert-warning">
        <i class="fas fa-clock"></i>
        Admin operations rate limit active. Try again in @_rateLimitCooldown.Value.Minutes minutes.
    </div>
}

@if (_loading)
{
    <div class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-primary">@_vms.Count</h3>
                    <p class="card-text">Total VMs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-success">@_vms.Count(v => v.Status == VmStatus.Running)</h3>
                    <p class="card-text">Running</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-secondary">@_vms.Count(v => v.Status == VmStatus.Stopped)</h3>
                    <p class="card-text">Stopped</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-info">@_owners.Count</h3>
                    <p class="card-text">Owners</p>
                </div>
            </div>
        </div>
    </div>

    @if (_vms.Count == 0)
    {
        <div class="alert alert-info">
            <h4 class="alert-heading"><i class="fas fa-info-circle"></i> No VMs Found</h4>
            <p>No virtual machines are currently registered. Once you link VMs to users, they will appear here.</p>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header">
                <h5 class="mb-0">Virtual Machines</h5>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th>VM</th>
                            <th>Owner</th>
                            <th>Node</th>
                            <th>Status</th>
                            <th>Resources</th>
                            <th>Last Synced</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (Vm vm in _vms)
                        {
                            User? owner = _owners.TryGetValue(vm.OwnerUserId, out User? o) ? o : null;
                            <tr class="@(_operationInProgress && _currentVm?.Id == vm.Id ? "table-primary" : "")">
                                <td>
                                    <div>
                                        <strong>@Sanitizer.SanitizeForDisplay(vm.Name)</strong><br />
                                        <small class="text-muted">ID: @vm.VmId</small>
                                    </div>
                                </td>
                                <td>
                                    @if (owner != null)
                                    {
                                        <div>
                                            <strong>@Sanitizer.SanitizeForDisplay(owner.DisplayName)</strong><br />
                                            <small class="text-muted">@Sanitizer.SanitizeForDisplay(owner.Email)</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No owner</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge bg-info">@Sanitizer.SanitizeForDisplay(vm.Node)</span>
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(vm.Status)">
                                        @if (_operationInProgress && _currentVm?.Id == vm.Id)
                                        {
                                            <i class="spinner-border spinner-border-sm me-1" aria-hidden="true"></i>
                                        }
                                        @vm.Status
                                    </span>
                                </td>
                                <td>
                                    <small>
                                        <i class="fas fa-microchip"></i> @vm.CpuCores cores<br />
                                        <i class="fas fa-memory"></i> @vm.MemoryMiB MB<br />
                                        <i class="fas fa-hdd"></i> @vm.DiskGiB GB
                                    </small>
                                </td>
                                <td>
                                    <small>@vm.LastSyncedAt.ToString("MMM d, HH:mm")</small>
                                </td>
                                <td>
                                    <div class="btn-group-vertical btn-group-sm" role="group">
                                        <button class="btn @(vm.Status == VmStatus.Running ? "btn-outline-secondary" : "btn-outline-success") btn-sm"
                                                @onclick="() => StartVmAsync(vm)"
                                                disabled="@(_operationInProgress || vm.Status == VmStatus.Running || _rateLimitCooldown.HasValue)"
                                                title="Start VM">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <button class="btn @(vm.Status == VmStatus.Stopped ? "btn-outline-secondary" : "btn-outline-warning") btn-sm"
                                                @onclick="() => StopVmAsync(vm)"
                                                disabled="@( _operationInProgress || vm.Status == VmStatus.Stopped || _rateLimitCooldown.HasValue ? "disabled" : null)"
                                                title="Stop VM">
                                            <i class="fas fa-stop"></i>
                                        </button>
                                        <button class="btn @(vm.Status == VmStatus.Stopped ? "btn-outline-secondary" : "btn-outline-danger") btn-sm"
                                                @onclick="() => ShutdownVmAsync(vm)"
                                                disabled="@( _operationInProgress || vm.Status == VmStatus.Stopped || _rateLimitCooldown.HasValue ? "disabled" : null)"
                                                title="Shutdown VM">
                                            <i class="fas fa-power-off"></i>
                                        </button>
                                        <button class="btn btn-outline-info btn-sm"
                                                @onclick="() => RefreshStatusAsync(vm)"
                                                disabled="@( _operationInProgress && _currentVm?.Id == vm.Id ? "disabled" : null)"
                                                title="Refresh Status">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@if (_message != null)
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="fas @(_isError ? "fa-exclamation-triangle text-danger" : "fa-check-circle text-success")"></i>
                <strong class="me-auto ms-2">@(_isError ? "Error" : "Success")</strong>
                <button type="button" class="btn-close" @onclick="ClearMessage"></button>
            </div>
            <div class="toast-body">
                @_message
            </div>
        </div>
    </div>
}

@code {
    private List<Vm> _vms = [];
    private Dictionary<Guid, User> _owners = new();
    private bool _loading = true;
    private bool _operationInProgress = false;
    private Vm? _currentVm = null;
    private string? _message = null;
    private bool _isError = false;
    private TimeSpan? _rateLimitCooldown = null;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadVmsAsync();
        await CheckRateLimitAsync();
    }

    private async Task LoadVmsAsync()
    {
        try
        {
            _vms = await Db.Vms.OrderBy(v => v.Name).ToListAsync();
            List<Guid> ownerIds = _vms.Select(v => v.OwnerUserId).Distinct().ToList();
            List<User> users = await Db.Users.Where(u => ownerIds.Contains(u.Id)).ToListAsync();
            _owners = users.ToDictionary(u => u.Id, u => u);

            await LogSecurityEventAsync("AdminVmListViewed", $"Admin viewed {_vms.Count} VMs", "Information");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load VMs for admin {UserId}", CurrentUserId);
            ShowMessage("Failed to load VMs. Please try again.", true);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CheckRateLimitAsync()
    {
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            _rateLimitCooldown = await RateLimit.GetRemainingCooldownAsync(CurrentUserId, "admin_operations");
            StateHasChanged();
        }
    }

    private async Task<bool> CheckOperationRateLimitAsync(string operation)
    {
        if (string.IsNullOrEmpty(CurrentUserId)) return false;

        bool allowed = await RateLimit.CheckRateLimitAsync(CurrentUserId, "admin_operations", 10, TimeSpan.FromMinutes(5));
        if (!allowed)
        {
            _rateLimitCooldown = await RateLimit.GetRemainingCooldownAsync(CurrentUserId, "admin_operations");
            await LogSecurityEventAsync("AdminRateLimitExceeded", $"Operation: {operation}", "Warning");
            ShowMessage($"Rate limit exceeded. Please wait {_rateLimitCooldown?.Minutes ?? 0} minutes before trying again.", true);
            return false;
        }

        return true;
    }

    private async Task RefreshAllVmsAsync()
    {
        if (!await CheckOperationRateLimitAsync("refresh_all")) return;

        _operationInProgress = true;
        StateHasChanged();

        try
        {
            int updated = 0;
            foreach (Vm vm in _vms)
            {
                try
                {
                    VmStatus status = await Proxmox.GetVmStatusAsync(vm.Node, vm.VmId);
                    if (vm.Status != status)
                    {
                        vm.Status = status;
                        updated++;
                    }
                    vm.LastSyncedAt = DateTimeOffset.UtcNow;
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to refresh VM {VmId}", vm.VmId);
                }
            }

            await Db.SaveChangesAsync();
            await LogSecurityEventAsync("AdminRefreshAllVms", $"Refreshed {_vms.Count} VMs, {updated} status changes", "Information");
            ShowMessage($"Refreshed all VMs. {updated} status changes detected.", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to refresh all VMs");
            ShowMessage("Failed to refresh all VMs. Please try again.", true);
        }
        finally
        {
            _operationInProgress = false;
            StateHasChanged();
        }
    }

    private async Task RefreshStatusAsync(Vm vm)
    {
        if (_operationInProgress || !Sanitizer.IsValidVmId(vm.VmId)) return;

        _operationInProgress = true;
        _currentVm = vm;
        StateHasChanged();

        try
        {
            VmStatus status = await Proxmox.GetVmStatusAsync(vm.Node, vm.VmId);
            vm.Status = status;
            vm.LastSyncedAt = DateTimeOffset.UtcNow;
            await Db.SaveChangesAsync();

            await LogSecurityEventAsync("AdminVmStatusRefreshed",
                $"VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId}) Status: {status}", "Information");
            ShowMessage($"Status refreshed for {vm.Name}: {status}", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin failed to refresh VM {VmId}", vm.VmId);
            ShowMessage($"Failed to refresh status for {vm.Name}", true);
        }
        finally
        {
            _operationInProgress = false;
            _currentVm = null;
            StateHasChanged();
        }
    }

    private async Task StartVmAsync(Vm vm)
    {
        await ExecuteVmOperationAsync(vm, "StartVm", "start", Proxmox.StartVmAsync);
    }

    private async Task StopVmAsync(Vm vm)
    {
        await ExecuteVmOperationAsync(vm, "StopVm", "stop", Proxmox.StopVmAsync);
    }

    private async Task ShutdownVmAsync(Vm vm)
    {
        await ExecuteVmOperationAsync(vm, "ShutdownVm", "shutdown", Proxmox.ShutdownVmAsync);
    }

    private async Task ExecuteVmOperationAsync(
        Vm vm,
        string actionName,
        string operationKey,
        Func<string, int, System.Threading.CancellationToken, Task> proxmoxAction)
    {
        if (!await CheckOperationRateLimitAsync(operationKey)) return;
        if (_operationInProgress || !Sanitizer.IsValidVmId(vm.VmId)) return;

        string sanitizedNode = Sanitizer.SanitizeNodeName(vm.Node);
        if (string.IsNullOrEmpty(sanitizedNode))
        {
            ShowMessage("Invalid node name", true);
            return;
        }

        _operationInProgress = true;
        _currentVm = vm;
        StateHasChanged();

        try
        {
            await proxmoxAction(sanitizedNode, vm.VmId, default);
            await LogSecurityEventAsync("AdminVmOperation",
                $"Operation: {actionName}, VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId})", "Information");
            ShowMessage($"{actionName} requested for {vm.Name}", false);

            // Refresh after a delay
            _ = Task.Delay(3000).ContinueWith(async _ => await RefreshStatusAsync(vm));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin failed to {Action} VM {VmId}", actionName, vm.VmId);
            await LogSecurityEventAsync("AdminVmOperationFailed",
                $"Operation: {actionName}, VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId}), Error: {ex.Message}", "Error");
            ShowMessage($"Failed to {actionName} for {vm.Name}. Please try again.", true);
        }
        finally
        {
            _operationInProgress = false;
            _currentVm = null;
            StateHasChanged();
        }
    }

    private static string GetStatusBadgeClass(VmStatus status) => status switch
    {
        VmStatus.Running => "bg-success",
        VmStatus.Stopped => "bg-secondary",
        VmStatus.Paused => "bg-warning",
        _ => "bg-dark"
    };

    private void ShowMessage(string message, bool isError)
    {
        _message = message;
        _isError = isError;
        StateHasChanged();

        _ = Task.Delay(5000).ContinueWith(_ => InvokeAsync(() =>
        {
            _message = null;
            StateHasChanged();
        }));
    }

    private void ClearMessage()
    {
        _message = null;
        StateHasChanged();
    }
}
