@page "/admin/vms"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize(Policy = VmPortal.Domain.Security.SecurityConstants.Policies.Admin)]
@inherits SecureComponentBase
@using System.Linq
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Domain.Users
@using VmPortal.Application.Proxmox
@using VmPortal.Application.Security
@inject VmPortalDbContext Db
@inject IProxmoxClient Proxmox
@inject IRateLimitingService RateLimit
@inject IInputSanitizer Sanitizer

<PageTitle>VM Administration</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="h4 mb-0"><i class="fas fa-server me-2"></i> VM Administration</h1>
    <div class="d-flex gap-2">
        <button class="btn btn-outline-primary"
                @onclick="RefreshAllVmsAsync"
                disabled="@_operationInProgress">
            <i class="fas fa-sync-alt me-1"></i> Refresh All
        </button>
    </div>
</div>

@if (_rateLimitCooldown.HasValue)
{
    <div class="alert alert-warning">
        <i class="fas fa-clock me-1"></i>
        Admin operations rate limit active. Try again in @_rateLimitCooldown.Value.Minutes minutes.
    </div>
}

@if (_loading)
{
    <div class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else
{
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-primary mb-0">@_vms.Count</h3>
                    <p class="card-text small mb-0">Total VMs</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-success mb-0">@_vms.Count(v => v.Status == VmStatus.Running)</h3>
                    <p class="card-text small mb-0">Running</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-secondary mb-0">@_vms.Count(v => v.Status == VmStatus.Stopped)</h3>
                    <p class="card-text small mb-0">Stopped</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center bg-light">
                <div class="card-body">
                    <h3 class="text-info mb-0">@_owners.Count</h3>
                    <p class="card-text small mb-0">Owners</p>
                </div>
            </div>
        </div>
    </div>

    @if (_vms.Count == 0)
    {
        <div class="alert alert-info">
            <h4 class="alert-heading h6"><i class="fas fa-info-circle me-1"></i> No VMs Found</h4>
            <p class="mb-0">No virtual machines are currently registered. Once you link VMs to users, they will appear here.</p>
        </div>
    }
    else
    {
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Virtual Machines</h5>
                <div class="d-flex align-items-center gap-2">
                    <input class="form-control form-control-sm"
                           style="min-width: 220px;"
                           placeholder="Search by VM or owner..."
                           @bind="_searchText"
                           @bind:event="oninput" />
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-hover mb-0">
                    <thead class="table-light">
                        <tr>
                            <th role="button" @onclick="() => ChangeSort(AdminVmSortColumn.Name)">
                                VM
                                <i class="fas @GetSortIconClasses(AdminVmSortColumn.Name) ms-1"></i>
                            </th>
                            <th role="button" @onclick="() => ChangeSort(AdminVmSortColumn.Owner)">
                                Owner
                                <i class="fas @GetSortIconClasses(AdminVmSortColumn.Owner) ms-1"></i>
                            </th>
                            <th role="button" @onclick="() => ChangeSort(AdminVmSortColumn.Node)">
                                Node
                                <i class="fas @GetSortIconClasses(AdminVmSortColumn.Node) ms-1"></i>
                            </th>
                            <th role="button" @onclick="() => ChangeSort(AdminVmSortColumn.Status)">
                                Status
                                <i class="fas @GetSortIconClasses(AdminVmSortColumn.Status) ms-1"></i>
                            </th>
                            <th>Resources</th>
                            <th role="button" @onclick="() => ChangeSort(AdminVmSortColumn.LastSynced)">
                                Last Synced
                                <i class="fas @GetSortIconClasses(AdminVmSortColumn.LastSynced) ms-1"></i>
                            </th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (Vm vm in GetFilteredVms())
                        {
                            User? owner = _owners.TryGetValue(vm.OwnerUserId, out User? o) ? o : null;
                            <tr class="@(_operationInProgress && _currentVm?.Id == vm.Id ? "table-primary" : string.Empty)">
                                <td>
                                    <div>
                                        <strong>@Sanitizer.SanitizeForDisplay(vm.Name)</strong><br />
                                        <small class="text-muted">ID: @vm.VmId</small>
                                    </div>
                                </td>
                                <td>
                                    @if (owner != null)
                                    {
                                        <div>
                                            <strong>@Sanitizer.SanitizeForDisplay(owner.DisplayName)</strong><br />
                                            <small class="text-muted">@Sanitizer.SanitizeForDisplay(owner.Email)</small>
                                        </div>
                                    }
                                    else
                                    {
                                        <span class="text-muted">No owner</span>
                                    }
                                </td>
                                <td>
                                    <span class="badge bg-info">@Sanitizer.SanitizeForDisplay(vm.Node)</span>
                                </td>
                                <td>
                                    <span class="badge @GetStatusBadgeClass(vm.Status)">
                                        @if (_operationInProgress && _currentVm?.Id == vm.Id)
                                        {
                                            <i class="spinner-border spinner-border-sm me-1" aria-hidden="true"></i>
                                        }
                                        @vm.Status
                                    </span>
                                </td>
                                <td>
                                    <small>
                                        <i class="fas fa-microchip"></i> @vm.CpuCores cores<br />
                                        <i class="fas fa-memory"></i> @vm.MemoryMiB MB<br />
                                        <i class="fas fa-hdd"></i> @vm.DiskGiB GB
                                    </small>
                                </td>
                                <td>
                                    <small>@vm.LastSyncedAt.ToString("MMM d, HH:mm")</small>
                                </td>
                                <td class="text-nowrap">
                                    <button class="btn btn-sm btn-success me-1"
                                            disabled="@(_operationInProgress || vm.Status == VmStatus.Running || _rateLimitCooldown.HasValue || vm.VmId <= 0)"
                                            @onclick="() => StartVmAsync(vm)">
                                        <i class="fas fa-play me-1"></i> Start
                                    </button>

                                    <button class="btn btn-sm btn-warning me-1"
                                            disabled="@(_operationInProgress || vm.Status != VmStatus.Running || _rateLimitCooldown.HasValue || vm.VmId <= 0)"
                                            @onclick="() => ShutdownVmAsync(vm)">
                                        <i class="fas fa-power-off me-1"></i> Shutdown
                                    </button>

                                    <a class="btn btn-sm btn-outline-primary"
                                       href="@($"/vm/{vm.Id}")"
                                       title="View details">
                                        <i class="fas fa-info-circle me-1"></i> Details
                                    </a>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        </div>
    }
}

@if (_message != null)
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 11">
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="fas @(_isError ? "fa-exclamation-triangle text-danger" : "fa-check-circle text-success")"></i>
                <strong class="me-auto ms-2">@(_isError ? "Error" : "Success")</strong>
                <button type="button" class="btn-close" @onclick="ClearMessage"></button>
            </div>
            <div class="toast-body">
                @_message
            </div>
        </div>
    </div>
}

@code {
    private enum AdminVmSortColumn
    {
        Name,
        Owner,
        Node,
        Status,
        LastSynced
    }

    private List<Vm> _vms = new List<Vm>();
    private Dictionary<Guid, User> _owners = new Dictionary<Guid, User>();
    private bool _loading = true;
    private bool _operationInProgress = false;
    private Vm? _currentVm = null;
    private string? _message = null;
    private bool _isError = false;
    private TimeSpan? _rateLimitCooldown = null;

    private string _searchText = string.Empty;
    private AdminVmSortColumn _sortColumn = AdminVmSortColumn.Name;
    private bool _sortDescending = false;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadVmsAsync();
        await CheckRateLimitAsync();
    }

    private async Task LoadVmsAsync()
    {
        try
        {
            _vms = await Db.Vms.OrderBy(v => v.Name).ToListAsync();
            List<Guid> ownerIds = _vms.Select(v => v.OwnerUserId).Distinct().ToList();
            List<User> users = await Db.Users.Where(u => ownerIds.Contains(u.Id)).ToListAsync();
            _owners = users.ToDictionary(u => u.Id, u => u);

            await LogSecurityEventAsync("AdminVmListViewed", $"Admin viewed {_vms.Count} VMs", "Information");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load VMs for admin {UserId}", CurrentUserId);
            ShowMessage("Failed to load VMs. Please try again.", true);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CheckRateLimitAsync()
    {
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            _rateLimitCooldown = await RateLimit.GetRemainingCooldownAsync(CurrentUserId, "admin_operations");
            StateHasChanged();
        }
    }

    private async Task<bool> CheckOperationRateLimitAsync(string operation)
    {
        if (string.IsNullOrEmpty(CurrentUserId))
        {
            return false;
        }

        bool allowed = await RateLimit.CheckRateLimitAsync(CurrentUserId, "admin_operations", 10, TimeSpan.FromMinutes(5));
        if (!allowed)
        {
            _rateLimitCooldown = await RateLimit.GetRemainingCooldownAsync(CurrentUserId, "admin_operations");
            await LogSecurityEventAsync("AdminRateLimitExceeded", $"Operation: {operation}", "Warning");
            ShowMessage($"Rate limit exceeded. Please wait {_rateLimitCooldown?.Minutes ?? 0} minutes before trying again.", true);
            return false;
        }

        return true;
    }

    private IEnumerable<Vm> GetFilteredVms()
    {
        IEnumerable<Vm> query = _vms;

        string term = _searchText?.Trim() ?? string.Empty;
        if (term.Length > 0)
        {
            string lower = term.ToLowerInvariant();
            query = query.Where(vm =>
            {
                string name = vm.Name ?? string.Empty;
                string node = vm.Node ?? string.Empty;

                bool matchesVm = name.Contains(lower, StringComparison.OrdinalIgnoreCase)
                                 || node.Contains(lower, StringComparison.OrdinalIgnoreCase);

                User? owner;
                bool matchesOwner = false;
                if (_owners.TryGetValue(vm.OwnerUserId, out owner) && owner != null)
                {
                    string display = owner.DisplayName ?? string.Empty;
                    string email = owner.Email ?? string.Empty;

                    matchesOwner = display.Contains(lower, StringComparison.OrdinalIgnoreCase)
                                   || email.Contains(lower, StringComparison.OrdinalIgnoreCase);
                }

                return matchesVm || matchesOwner;
            });
        }

        switch (_sortColumn)
        {
            case AdminVmSortColumn.Owner:
                query = _sortDescending
                    ? query.OrderByDescending(vm => GetOwnerSortKey(vm))
                    : query.OrderBy(vm => GetOwnerSortKey(vm));
                break;
            case AdminVmSortColumn.Node:
                query = _sortDescending
                    ? query.OrderByDescending(vm => vm.Node)
                    : query.OrderBy(vm => vm.Node);
                break;
            case AdminVmSortColumn.Status:
                query = _sortDescending
                    ? query.OrderByDescending(vm => vm.Status)
                    : query.OrderBy(vm => vm.Status);
                break;
            case AdminVmSortColumn.LastSynced:
                query = _sortDescending
                    ? query.OrderByDescending(vm => vm.LastSyncedAt)
                    : query.OrderBy(vm => vm.LastSyncedAt);
                break;
            case AdminVmSortColumn.Name:
            default:
                query = _sortDescending
                    ? query.OrderByDescending(vm => vm.Name)
                    : query.OrderBy(vm => vm.Name);
                break;
        }

        return query;
    }

    private string GetOwnerSortKey(Vm vm)
    {
        User? owner;
        if (_owners.TryGetValue(vm.OwnerUserId, out owner) && owner != null)
        {
            if (!string.IsNullOrEmpty(owner.DisplayName))
            {
                return owner.DisplayName;
            }

            if (!string.IsNullOrEmpty(owner.Email))
            {
                return owner.Email;
            }
        }

        return string.Empty;
    }

    private void ChangeSort(AdminVmSortColumn column)
    {
        if (_sortColumn == column)
        {
            _sortDescending = !_sortDescending;
        }
        else
        {
            _sortColumn = column;
            _sortDescending = false;
        }
    }

    private string GetSortIconClasses(AdminVmSortColumn column)
    {
        if (_sortColumn != column)
        {
            return "fa-sort text-muted";
        }

        if (_sortDescending)
        {
            return "fa-sort-down";
        }

        return "fa-sort-up";
    }

    private async Task RefreshAllVmsAsync()
    {
        if (!await CheckOperationRateLimitAsync("refresh_all"))
        {
            return;
        }

        _operationInProgress = true;
        StateHasChanged();

        try
        {
            int updated = 0;
            foreach (Vm vm in _vms)
            {
                try
                {
                    VmStatus status = await Proxmox.GetVmStatusAsync(vm.Node, vm.VmId);
                    if (vm.Status != status)
                    {
                        vm.Status = status;
                        updated++;
                    }
                    vm.LastSyncedAt = DateTimeOffset.UtcNow;
                }
                catch (Exception ex)
                {
                    Logger.LogWarning(ex, "Failed to refresh VM {VmId}", vm.VmId);
                }
            }

            await Db.SaveChangesAsync();
            await LogSecurityEventAsync("AdminRefreshAllVms", $"Refreshed {_vms.Count} VMs, {updated} status changes", "Information");
            ShowMessage($"Refreshed all VMs. {updated} status changes detected.", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to refresh all VMs");
            ShowMessage("Failed to refresh all VMs. Please try again.", true);
        }
        finally
        {
            _operationInProgress = false;
            StateHasChanged();
        }
    }

    private async Task RefreshStatusAsync(Vm vm)
    {
        if (_operationInProgress || !Sanitizer.IsValidVmId(vm.VmId))
        {
            return;
        }

        _operationInProgress = true;
        _currentVm = vm;
        StateHasChanged();

        try
        {
            VmStatus status = await Proxmox.GetVmStatusAsync(vm.Node, vm.VmId);
            vm.Status = status;
            vm.LastSyncedAt = DateTimeOffset.UtcNow;
            await Db.SaveChangesAsync();

            await LogSecurityEventAsync("AdminVmStatusRefreshed",
                $"VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId}) Status: {status}", "Information");
            ShowMessage($"Status refreshed for {vm.Name}: {status}", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin failed to refresh VM {VmId}", vm.VmId);
            ShowMessage($"Failed to refresh status for {vm.Name}", true);
        }
        finally
        {
            _operationInProgress = false;
            _currentVm = null;
            StateHasChanged();
        }
    }

    private async Task StartVmAsync(Vm vm)
    {
        await ExecuteVmOperationAsync(vm, "StartVm", "start", Proxmox.StartVmAsync);
    }

    private async Task StopVmAsync(Vm vm)
    {
        await ExecuteVmOperationAsync(vm, "StopVm", "stop", Proxmox.StopVmAsync);
    }

    private async Task ShutdownVmAsync(Vm vm)
    {
        await ExecuteVmOperationAsync(vm, "ShutdownVm", "shutdown", Proxmox.ShutdownVmAsync);
    }

    private async Task ExecuteVmOperationAsync(
        Vm vm,
        string actionName,
        string operationKey,
        Func<string, int, System.Threading.CancellationToken, Task> proxmoxAction)
    {
        if (!await CheckOperationRateLimitAsync(operationKey))
        {
            return;
        }

        if (_operationInProgress || !Sanitizer.IsValidVmId(vm.VmId))
        {
            return;
        }

        string sanitizedNode = Sanitizer.SanitizeNodeName(vm.Node);
        if (string.IsNullOrEmpty(sanitizedNode))
        {
            ShowMessage("Invalid node name", true);
            return;
        }

        _operationInProgress = true;
        _currentVm = vm;
        StateHasChanged();

        try
        {
            await proxmoxAction(sanitizedNode, vm.VmId, default);
            await LogSecurityEventAsync("AdminVmOperation",
                $"Operation: {actionName}, VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId})", "Information");
            ShowMessage($"{actionName} requested for {vm.Name}", false);

            _ = Task.Delay(3000).ContinueWith(async _ => await RefreshStatusAsync(vm));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Admin failed to {Action} VM {VmId}", actionName, vm.VmId);
            await LogSecurityEventAsync("AdminVmOperationFailed",
                $"Operation: {actionName}, VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId}), Error: {ex.Message}", "Error");
            ShowMessage($"Failed to {actionName} for {vm.Name}. Please try again.", true);
        }
        finally
        {
            _operationInProgress = false;
            _currentVm = null;
            StateHasChanged();
        }
    }

    private static string GetStatusBadgeClass(VmStatus status) => status switch
    {
        VmStatus.Running => "bg-success",
        VmStatus.Stopped => "bg-secondary",
        VmStatus.Paused => "bg-warning",
        _ => "bg-dark"
    };

    private void ShowMessage(string message, bool isError)
    {
        _message = message;
        _isError = isError;
        StateHasChanged();

        _ = Task.Delay(5000).ContinueWith(_ => InvokeAsync(() =>
        {
            _message = null;
            StateHasChanged();
        }));
    }

    private void ClearMessage()
    {
        _message = null;
        StateHasChanged();
    }
}
