@page "/vm/{id:guid}"
@rendermode InteractiveServer
@using System
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inherits SecureComponentBase
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Domain.Users
@using VmPortal.Application.Security
@using VmPortal.Application.Proxmox
@using VmPortal.Application.Vms
@inject VmPortalDbContext Db
@inject IProxmoxClient Proxmox
@inject IInputSanitizer Sanitizer
@inject NavigationManager Nav
@inject Microsoft.Extensions.Options.IOptions<VmResourceLimitsOptions> VmLimitsOptions
@inject IJSRuntime JS
@using VmPortal.Application.Console
@inject IConsoleSessionService ConsoleSessionService
@implements IAsyncDisposable
@using Microsoft.AspNetCore.Components.Authorization

<PageTitle>VM Details</PageTitle>

@if (_loading)
{
    <div class="d-flex justify-content-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_vm == null)
{
    <div class="alert alert-danger">
        VM not found or not accessible.
    </div>
}
else
{
    <div class="mb-3">
        <div class="d-flex flex-wrap justify-content-between align-items-center">
            <div class="mb-2">
                <h1 class="h3 mb-1">@Sanitizer.SanitizeForDisplay(_vm.Name)</h1>
                <div class="text-muted small">
                    Node: @Sanitizer.SanitizeForDisplay(_vm.Node),
                    VMID: @_vm.VmId
                </div>
            </div>
            <div class="mb-2">
                <span class="badge @GetStatusBadgeClass(_vm.Status) me-2">
                    @_vm.Status
                </span>
                <span class="text-muted small">
                    Last synced: @_vm.LastSyncedAt.ToString("u")
                </span>
            </div>
        </div>
    </div>

    @if (!string.IsNullOrEmpty(_message))
    {
        <div class="alert @(_isError ? "alert-danger" : "alert-success") mb-3">
            @_message
        </div>
    }

    @if (_vm != null && _vm.IsDisabled)
    {
        <div class="alert alert-warning small">
            This VM has been disabled by the system (or delete request). Actions may be limited.
        </div>
    }

    <div class="row">
        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header">
                    Power & Actions
                </div>
                <div class="card-body">
                    <p class="text-muted small">
                        Use these actions to start, stop or restart the VM. Advanced actions are available as needed.
                    </p>

                    <div class="mb-3">
                        <div class="btn-group me-2 mb-2" role="group">
                            <button class="btn btn-success btn-sm"
                                    disabled="@(!_canStart || _busy || _vm!.VmId <= 0)"
                                    @onclick="StartVm">
                                <i class="fas fa-play me-1"></i> Start
                            </button>
                            <button class="btn btn-warning btn-sm"
                                    disabled="@(!_canShutdown || _busy || _vm!.VmId <= 0)"
                                    @onclick="ShutdownVm">
                                <i class="fas fa-power-off me-1"></i> Shutdown
                            </button>
                            <button class="btn btn-primary btn-sm"
                                    disabled="@(!_canRestart || _busy || _vm!.VmId <= 0)"
                                    @onclick="RestartVm">
                                <i class="fas fa-redo me-1"></i> Restart
                            </button>
                        </div>
                    </div>

                    <details class="mb-3">
                        <summary class="small text-muted">
                            Advanced actions
                        </summary>
                        <div class="mt-2">
                            <div class="btn-group me-2 mb-2" role="group">
                                <button class="btn btn-outline-danger btn-sm"
                                        disabled="@(!_canHardStop || _busy || _vm!.VmId <= 0)"
                                        @onclick="HardStopVm">
                                    <i class="fas fa-stop me-1"></i> Hard Stop
                                </button>
                                <button class="btn btn-outline-danger btn-sm"
                                        disabled="@(!_canReset || _busy || _vm!.VmId <= 0)"
                                        @onclick="ResetVm">
                                    <i class="fas fa-bolt me-1"></i> Hard Reset
                                </button>
                                @if (_canDelete)
                                {
                                    <button class="btn btn-outline-danger btn-sm ms-2"
                                            disabled="@(_busy || _vm == null || _vm.VmId <= 0 || _vm.IsDisabled)"
                                            @onclick="DeleteVmAsync">
                                        <i class="fas fa-trash me-1"></i> Delete
                                    </button>
                                }
                            </div>
                            <div class="btn-group mb-2" role="group">
                                <button class="btn btn-outline-secondary btn-sm"
                                        disabled="@(!_canPause || _busy || _vm!.VmId <= 0)"
                                        @onclick="PauseVm">
                                    <i class="fas fa-pause me-1"></i> Pause
                                </button>
                                <button class="btn btn-outline-secondary btn-sm"
                                        disabled="@(!_canResume || _busy || _vm!.VmId <= 0)"
                                        @onclick="ResumeVm">
                                    <i class="fas fa-play-circle me-1"></i> Resume
                                </button>
                            </div>
                        </div>
                    </details>

                    <button class="btn btn-outline-info btn-sm"
                            disabled="@_busy"
                            @onclick="RefreshStatus">
                        <i class="fas fa-sync-alt me-1"></i> Refresh status
                    </button>
                </div>
            </div>
        </div>

        <div class="col-lg-6 mb-3">
            <div class="card h-100">
                <div class="card-header">
                    Access (RDP, SSH & Console)
                </div>
                <div class="card-body">
                    @if (_vm != null)
                    {
                        <div class="mb-2">
                            @if (_vm.Status == VmStatus.Running)
                            {
                                <span class="badge bg-success me-2">Status: Running</span>
                                <span class="text-muted small">Remote access is available.</span>
                            }
                            else if (_vm.Status == VmStatus.Stopped)
                            {
                                <span class="badge bg-secondary me-2">Status: Stopped</span>
                                <span class="text-warning small">
                                    Start the VM to use console, RDP or SSH.
                                </span>
                            }
                            else if (_vm.Status == VmStatus.Paused)
                            {
                                <span class="badge bg-warning text-dark me-2">Status: Paused</span>
                                <span class="text-muted small">
                                    Resume the VM to interact with it.
                                </span>
                            }
                            else
                            {
                                <span class="badge bg-dark me-2">Status: @_vm.Status</span>
                            }
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_consoleError))
                    {
                        <div class="alert alert-danger py-1 mb-2">
                            @_consoleError
                        </div>
                    }

                    @if (!string.IsNullOrEmpty(_consoleStatus))
                    {
                        <div class="alert alert-info py-1 mb-2">
                            @_consoleStatus
                        </div>
                    }

                    <p class="text-muted small mb-2">
                        Opens an embedded console via Proxmox (noVNC) in the panel below.
                    </p>

                    <button class="btn btn-sm btn-dark mb-2"
                            disabled="@(_consoleOpening || _vm == null || _vm.VmId <= 0 || _vm.Status != VmStatus.Running)"
                            @onclick="OpenConsoleAsync">
                        @if (_consoleOpening)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Open Console
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            Console
        </div>
        <div class="card-body p-0">
            <div class="border-0"
                 style="width: 100%; height: 75vh; overflow: hidden;">
                <iframe id="vnc-iframe"
                        src=""
                        allow="pointer-lock"
                        style="width: 100%; height: 100%; border: none; background-color: #000; overflow: hidden;">
                </iframe>
            </div>
        </div>
    </div>

    <div class="card mb-3">
        <div class="card-header">
            Resources
        </div>
        <div class="card-body">
            @if (_vm != null)
            {
                Vm vmLocal = _vm!;

                <dl class="row mb-2">
                    <dt class="col-sm-3">CPU Cores</dt>
                    <dd class="col-sm-9">
                        @vmLocal.CpuCores
                        @if (_effectiveMaxCpuCores > 0)
                        {
                            <span class="text-muted small"> / @_effectiveMaxCpuCores</span>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar bg-info"
                                     role="progressbar"
                                     style="width: @GetCpuUsagePercent()%;">
                                </div>
                            </div>
                        }
                    </dd>

                    <dt class="col-sm-3">Memory (MiB)</dt>
                    <dd class="col-sm-9">
                        @vmLocal.MemoryMiB
                        @if (_effectiveMaxMemoryMiB > 0)
                        {
                            <span class="text-muted small"> / @_effectiveMaxMemoryMiB</span>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar bg-success"
                                     role="progressbar"
                                     style="width: @GetMemoryUsagePercent()%;">
                                </div>
                            </div>
                        }
                    </dd>

                    <dt class="col-sm-3">Disk (GiB)</dt>
                    <dd class="col-sm-9">
                        @vmLocal.DiskGiB
                        @if (_effectiveMaxDiskGiB > 0)
                        {
                            <span class="text-muted small"> / @_effectiveMaxDiskGiB</span>
                            <div class="progress mt-1" style="height: 6px;">
                                <div class="progress-bar bg-warning"
                                     role="progressbar"
                                     style="width: @GetDiskUsagePercent()%;">
                                </div>
                            </div>
                        }
                    </dd>
                </dl>
            }

            <p class="text-muted small">
                Changes to CPU and memory will apply on next reboot. Disk resize applies immediately.
            </p>

            <hr />

            <h5 class="mt-3">Adjust Resources</h5>
            <p class="text-muted mb-3 small">
                You can increase CPU, memory and disk size within the configured limits.
                Decreasing resources is not allowed.
            </p>

            <EditForm Model="_resourceModel"
                      OnValidSubmit="UpdateResourcesAsync">
                <DataAnnotationsValidator />
                <ValidationSummary />

                <fieldset disabled="@(_busy || !_canManageResources)">
                    @if (_vm != null && _vm.Status == VmStatus.Running)
                    {
                        <div class="alert alert-warning py-1 small">
                            Some changes may only apply after a reboot.
                        </div>
                    }
                    <div class="row mb-3">
                        <div class="col-md-4">
                            <label class="form-label">CPU Cores</label>
                            <InputNumber class="form-control" @bind-Value="_resourceModel.CpuCores" />
                            @{
                                string? cpuError = GetCpuError();
                                if (!string.IsNullOrEmpty(cpuError))
                                {
                                    <div class="text-danger small">@cpuError</div>
                                }
                                else
                                {
                                    <div class="form-text">
                                        Allowed: 1 – @_effectiveMaxCpuCores (current: @_vm!.CpuCores)
                                    </div>
                                }
                            }
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Memory (MiB)</label>
                            <InputNumber class="form-control" @bind-Value="_resourceModel.MemoryMiB" />
                            @{
                                string? memError = GetMemoryError();
                                if (!string.IsNullOrEmpty(memError))
                                {
                                    <div class="text-danger small">@memError</div>
                                }
                                else
                                {
                                    <div class="form-text">
                                        Allowed: 1 – @_effectiveMaxMemoryMiB MiB (current: @_vm!.MemoryMiB MiB)
                                    </div>
                                }
                            }
                        </div>
                        <div class="col-md-4">
                            <label class="form-label">Disk (GiB)</label>
                            <InputNumber class="form-control" @bind-Value="_resourceModel.DiskGiB" />
                            @{
                                string? diskError = GetDiskError();
                                if (!string.IsNullOrEmpty(diskError))
                                {
                                    <div class="text-danger small">@diskError</div>
                                }
                                else
                                {
                                    <div class="form-text">
                                        Min: @_vm!.DiskGiB GiB, Max: @_effectiveMaxDiskGiB GiB (disk can only be increased)
                                    </div>
                                }
                            }
                        </div>
                    </div>

                    <button type="submit" class="btn btn-primary btn-sm"
                            disabled="@(_busy || _vm!.VmId <= 0)">
                        @if (_busy)
                        {
                            <span class="spinner-border spinner-border-sm me-1"></span>
                        }
                        Apply Resource Changes
                    </button>
                </fieldset>
            </EditForm>
        </div>
    </div>

    <AuthorizeView Roles="Admin">
        <div class="card mb-3">
            <div class="card-header">
                Access & Permissions
            </div>
            <div class="card-body">
                @if (_vm != null)
                {
                    <p class="small mb-1">
                        Primary owner:
                        <strong>@(_primaryOwnerName ?? "Unknown")</strong>
                    </p>

                    <h6 class="small mt-3">Additional users</h6>
                    <ul class="list-unstyled small mb-2">
                        @foreach (VmPermissionDisplay perm in _vmPermissions)
                        {
                            <li class="mb-1">
                                <strong>@perm.UserDisplayName</strong>
                                @if (!string.IsNullOrEmpty(perm.UserEmail))
                                {
                                    <span class="text-muted">(@perm.UserEmail)</span>
                                }
                                <div class="form-check form-check-inline ms-2">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           checked="@perm.CanDelete"
                                           @onchange="@(_ => ToggleDeletePermissionAsync(perm.PermissionId))" />
                                    <label class="form-check-label small">Can delete</label>
                                </div>
                                <div class="form-check form-check-inline">
                                    <input class="form-check-input"
                                           type="checkbox"
                                           checked="@perm.CanManageResources"
                                           @onchange="@(_ => ToggleManagePermissionAsync(perm.PermissionId))" />
                                    <label class="form-check-label small">Can manage resources</label>
                                </div>
                                <button type="button"
                                        class="btn btn-sm btn-outline-danger ms-2"
                                        @onclick="() => RemovePermissionAsync(perm.PermissionId)">
                                    Remove
                                </button>
                            </li>
                        }
                        @if (_vmPermissions.Count == 0)
                        {
                            <li class="text-muted">No additional users.</li>
                        }
                    </ul>

                    <hr />

                    <h6 class="small">Add user</h6>
                    @if (!string.IsNullOrEmpty(_permissionError))
                    {
                        <div class="alert alert-warning py-1 small mb-2">
                            @_permissionError
                        </div>
                    }
                    <div class="input-group input-group-sm mb-2">
                        <input class="form-control"
                               placeholder="User email or display name"
                               @bind="_newPermissionUserInput"
                               @bind:event="oninput" />
                        <button class="btn btn-outline-primary"
                                type="button"
                                disabled="@_permissionsBusy"
                                @onclick="AddPermissionAsync">
                            @if (_permissionsBusy)
                            {
                                <span class="spinner-border spinner-border-sm me-1"></span>
                            }
                            Add
                        </button>
                    </div>
                    <p class="text-muted small mb-0">
                        Only Admins can manage VM access. Owners always have full permissions.
                    </p>
                }
            </div>
        </div>
    </AuthorizeView>

    <div class="d-flex justify-content-between mt-3">
        <button class="btn btn-secondary" @onclick="BackToList">
            Back to My VMs
        </button>
        <span class="text-muted small align-self-center">
            Console powered by Proxmox noVNC.
        </span>
    </div>

    <br />
}

@code {
    [Parameter]
    public Guid Id { get; set; }

    private Vm? _vm;
    private bool _loading = true;
    private bool _busy = false;
    private string? _message;
    private bool _isError;
    private CancellationTokenSource? _messageCts;

    private bool _canStart;
    private bool _canShutdown;
    private bool _canHardStop;
    private bool _canRestart;
    private bool _canReset;
    private bool _canPause;
    private bool _canResume;

    private bool _consoleOpening;
    private string? _consoleStatus;
    private string? _consoleError;
    private string? _currentConsoleSessionId;

    private bool _canDelete;
    private bool _canManageResources;

    private String _vncUrl = String.Empty;

    private CancellationTokenSource? _statusRefreshCts;

    private VmResourceLimitsOptions _limits = new VmResourceLimitsOptions();

    private ResourceUpdateModel _resourceModel = new ResourceUpdateModel();

    private sealed class ResourceUpdateModel
    {
        public int CpuCores { get; set; }
        public int MemoryMiB { get; set; }
        public int DiskGiB { get; set; }
    }

    private int _effectiveMaxCpuCores;
    private int _effectiveMaxMemoryMiB;
    private int _effectiveMaxDiskGiB;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _limits = VmLimitsOptions.Value;
        await LoadVmAsync();
        await LoadPermissionsAsync();
        StartStatusRefreshLoop();
    }

    private async Task LoadVmAsync()
    {
        try
        {
            _vm = await Db.Vms.FirstOrDefaultAsync(v => v.Id == Id);
            if (_vm != null)
            {
                // Compute effective max CPU
                int cpuMax = _limits.MaxCpuCores > 0 ? _limits.MaxCpuCores : int.MaxValue;
                if (_vm.MaxCpuCores.HasValue)
                {
                    cpuMax = Math.Min(cpuMax, _vm.MaxCpuCores.Value);
                }

                _effectiveMaxCpuCores = cpuMax == int.MaxValue ? 0 : cpuMax;

                // Effective max memory
                int memMax = _limits.MaxMemoryMiB > 0 ? _limits.MaxMemoryMiB : int.MaxValue;
                if (_vm.MaxMemoryMiB.HasValue)
                {
                    memMax = Math.Min(memMax, _vm.MaxMemoryMiB.Value);
                }

                _effectiveMaxMemoryMiB = memMax == int.MaxValue ? 0 : memMax;

                // Effective max disk
                int diskMax = _limits.MaxDiskGiB > 0 ? _limits.MaxDiskGiB : int.MaxValue;
                if (_vm.MaxDiskGiB.HasValue)
                {
                    diskMax = Math.Min(diskMax, _vm.MaxDiskGiB.Value);
                }

                _effectiveMaxDiskGiB = diskMax == int.MaxValue ? 0 : diskMax;

                UpdateActionAvailability();
                _resourceModel = new ResourceUpdateModel
                {
                    CpuCores = _vm.CpuCores,
                    MemoryMiB = _vm.MemoryMiB,
                    DiskGiB = _vm.DiskGiB
                };
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load VM {VmId}", Id);
            _vm = null;
        }
        finally
        {
            _loading = false;
        }
    }

    private void UpdateActionAvailability()
    {
        if (_vm == null)
        {
            _canStart = false;
            _canShutdown = false;
            _canHardStop = false;
            _canRestart = false;
            _canReset = false;
            _canPause = false;
            _canResume = false;
            return;
        }

        VmStatus status = _vm.Status;

        _canStart = status == VmStatus.Stopped;
        _canShutdown = status == VmStatus.Running;
        _canHardStop = status == VmStatus.Running || status == VmStatus.Paused;
        _canRestart = status == VmStatus.Running;
        _canReset = status == VmStatus.Running || status == VmStatus.Paused;
        _canPause = status == VmStatus.Running;
        _canResume = status == VmStatus.Paused;
    }

    private static string GetStatusBadgeClass(VmStatus status)
    {
        return status switch
        {
            VmStatus.Running => "bg-success",
            VmStatus.Stopped => "bg-secondary",
            VmStatus.Paused => "bg-warning",
            _ => "bg-dark"
        };
    }

    private Task RefreshStatus() => RefreshStatusInternalAsync(true);

    private async Task RefreshStatusInternalAsync(bool showUiFeedback)
    {
        if (_vm == null || _vm.VmId <= 0)
        {
            return;
        }

        if (showUiFeedback)
        {
            _busy = true;
            ClearMessage();
            StateHasChanged();
        }

        try
        {
            VmStatus status = await Proxmox.GetVmStatusAsync(_vm.Node, _vm.VmId);

            bool statusChanged = _vm.Status != status;
            _vm.Status = status;
            _vm.LastSyncedAt = DateTimeOffset.UtcNow;

            if (statusChanged)
            {
                UpdateActionAvailability();
            }

            if (showUiFeedback)
            {
                ShowMessage($"Status refreshed: {status}", false);
            }
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to refresh status for VM {Vm}", _vm.Id);
            if (showUiFeedback)
            {
                ShowMessage("Failed to refresh VM status.", true);
            }
        }
        finally
        {
            if (showUiFeedback)
            {
                _busy = false;
            }

            StateHasChanged();
        }
    }

    private async Task StartVm() => await ExecuteVmAction("StartVm", Proxmox.StartVmAsync, "Start requested.");
    private async Task ShutdownVm() => await ExecuteVmAction("ShutdownVm", Proxmox.ShutdownVmAsync, "Shutdown requested.");
    private async Task HardStopVm() => await ExecuteVmAction("HardStopVm", Proxmox.StopVmAsync, "Hard stop requested.");
    private async Task RestartVm() => await ExecuteVmAction("RebootVm", Proxmox.RebootVmAsync, "Restart requested.");
    private async Task ResetVm() => await ExecuteVmAction("ResetVm", Proxmox.ResetVmAsync, "Hard reset requested.");
    private async Task PauseVm() => await ExecuteVmAction("PauseVm", Proxmox.PauseVmAsync, "Pause requested.");
    private async Task ResumeVm() => await ExecuteVmAction("ResumeVm", Proxmox.ResumeVmAsync, "Resume requested.");

    private async Task ExecuteVmAction(
        string actionName,
        Func<string, int, System.Threading.CancellationToken, Task> proxmoxAction,
        string successMessage)
    {
        if (_vm == null || _busy || _vm.VmId <= 0)
        {
            return;
        }

        _busy = true;
        ClearMessage();
        StateHasChanged();

        try
        {
            string nodeName = Sanitizer.SanitizeNodeName(_vm.Node);
            if (string.IsNullOrEmpty(nodeName))
            {
                ShowMessage("Invalid node name.", true);
                _busy = false;
                return;
            }

            await proxmoxAction(nodeName, _vm.VmId, default);

            await LogSecurityEventAsync(
                "VmAction",
                $"Action: {actionName}, VM: {Sanitizer.SanitizeForLog(_vm.Name)} ({_vm.VmId})",
                "Information");

            ShowMessage(successMessage, false);

            await Task.Delay(1000);
            await RefreshStatusInternalAsync(true);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to execute {Action} for VM {VmId}", actionName, _vm.VmId);
            await LogSecurityEventAsync(
                "VmActionFailed",
                $"Action: {actionName}, VM: {(_vm != null ? Sanitizer.SanitizeForLog(_vm.Name) : "unknown")}, Error: {ex.Message}",
                "Error");
            ShowMessage($"Failed to execute {actionName}.", true);
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

    private string? GetCpuError()
    {
        if (_vm == null)
        {
            return null;
        }

        int newCpu = _resourceModel.CpuCores;
        if (newCpu <= 0)
        {
            return "CPU cores must be positive.";
        }

        if (_effectiveMaxCpuCores > 0 && newCpu > _effectiveMaxCpuCores)
        {
            return $"CPU cores cannot exceed the configured maximum ({_effectiveMaxCpuCores}).";
        }

        return null;
    }

    private string? GetMemoryError()
    {
        if (_vm == null)
        {
            return null;
        }

        int newMem = _resourceModel.MemoryMiB;
        if (newMem <= 0)
        {
            return "Memory must be positive.";
        }

        if (_effectiveMaxMemoryMiB > 0 && newMem > _effectiveMaxMemoryMiB)
        {
            return $"Memory cannot exceed the configured maximum ({_effectiveMaxMemoryMiB} MiB).";
        }

        return null;
    }

    private string? GetDiskError()
    {
        if (_vm == null)
        {
            return null;
        }

        int newDisk = _resourceModel.DiskGiB;
        if (newDisk <= 0)
        {
            return "Disk size must be positive.";
        }

        if (newDisk < _vm.DiskGiB)
        {
            return $"Disk size cannot be smaller than the current value ({_vm.DiskGiB} GiB).";
        }

        if (_effectiveMaxDiskGiB > 0 && newDisk > _effectiveMaxDiskGiB)
        {
            return $"Disk size cannot exceed the configured maximum ({_effectiveMaxDiskGiB} GiB).";
        }

        return null;
    }

    private async Task UpdateResourcesAsync()
    {
        if (_vm == null || _busy || _vm.VmId <= 0)
        {
            return;
        }

        string? cpuError = GetCpuError();
        string? memError = GetMemoryError();
        string? diskError = GetDiskError();

        if (!string.IsNullOrEmpty(cpuError) ||
            !string.IsNullOrEmpty(memError) ||
            !string.IsNullOrEmpty(diskError))
        {
            ShowMessage("Resource validation failed. Please correct the highlighted fields.", true);
            return;
        }

        _busy = true;
        ClearMessage();
        StateHasChanged();

        try
        {
            string nodeName = Sanitizer.SanitizeNodeName(_vm.Node);
            if (string.IsNullOrEmpty(nodeName))
            {
                ShowMessage("Invalid node name.", true);
                _busy = false;
                return;
            }

            bool cpuMemChanged = _resourceModel.CpuCores != _vm.CpuCores ||
                                 _resourceModel.MemoryMiB != _vm.MemoryMiB;
            bool diskChanged = _resourceModel.DiskGiB != _vm.DiskGiB;

            if (cpuMemChanged)
            {
                await Proxmox.ConfigureVmResourcesAsync(
                    nodeName,
                    _vm.VmId,
                    _resourceModel.CpuCores,
                    _resourceModel.MemoryMiB,
                    default);

                await LogSecurityEventAsync(
                    "VmResourcesUpdated",
                    $"VM: {Sanitizer.SanitizeForLog(_vm.Name)} ({_vm.VmId}), CPU: {_resourceModel.CpuCores}, RAM: {_resourceModel.MemoryMiB} MiB",
                    "Information");

                _vm.CpuCores = _resourceModel.CpuCores;
                _vm.MemoryMiB = _resourceModel.MemoryMiB;
            }

            if (diskChanged && _resourceModel.DiskGiB > _vm.DiskGiB)
            {
                await Proxmox.ResizeVmDiskAsync(
                    nodeName,
                    _vm.VmId,
                    _resourceModel.DiskGiB,
                    default);

                await LogSecurityEventAsync(
                    "VmDiskResized",
                    $"VM: {Sanitizer.SanitizeForLog(_vm.Name)} ({_vm.VmId}), Disk: {_resourceModel.DiskGiB} GiB (from {_vm.DiskGiB} GiB)",
                    "Information");

                _vm.DiskGiB = _resourceModel.DiskGiB;
            }

            _vm.LastSyncedAt = DateTimeOffset.UtcNow;
            await Db.SaveChangesAsync();

            ShowMessage("Resources updated successfully.", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to update resources for VM {VmId}", _vm.VmId);
            await LogSecurityEventAsync(
                "VmResourceUpdateFailed",
                $"VM: {(_vm != null ? Sanitizer.SanitizeForLog(_vm.Name) : "unknown")}, Error: {ex.Message}",
                "Error");
            ShowMessage("Failed to update VM resources.", true);
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

    private void ShowMessage(string message, bool isError)
    {
        // Cancel any pending auto-clear
        _messageCts?.Cancel();
        _messageCts = new CancellationTokenSource();
        CancellationToken token = _messageCts.Token;

        _message = message;
        _isError = isError;
        StateHasChanged();

        // Fire-and-forget task to clear message after 10 seconds
        _ = Task.Run(async () =>
        {
            try
            {
                await Task.Delay(TimeSpan.FromSeconds(10), token);
                if (token.IsCancellationRequested)
                {
                    return;
                }

                await InvokeAsync(() =>
                {
                    // Only clear if it’s still the same message
                    if (_message == message)
                    {
                        _message = null;
                        _isError = false;
                        StateHasChanged();
                    }
                });
            }
            catch (TaskCanceledException)
            {
                // ignore
            }
        }, token);
    }

    private void ClearMessage()
    {
        _message = null;
        _isError = false;
    }

    private void BackToList()
    {
        Nav.NavigateTo("/my-vms");
    }

    private async Task OpenConsoleAsync()
    {
        if (_vm == null || _consoleOpening)
        {
            return;
        }

        _consoleOpening = true;
        _consoleError = null;
        _consoleStatus = null;
        StateHasChanged();

        try
        {
            if (string.IsNullOrEmpty(CurrentUserId))
            {
                _consoleError = "Current user could not be resolved.";
                return;
            }

            if (_vm.Status != VmStatus.Running)
            {
                _consoleError = $"VM is not running (current status: {_vm.Status}). Start the VM before opening the console.";
                return;
            }

            if (_vm.VmId <= 0 || string.IsNullOrWhiteSpace(_vm.Node))
            {
                _consoleError = "This VM is not linked to a Proxmox VMID or node.";
                return;
            }

            string nodeName = _vm.Node.Trim();

            _consoleStatus = "Opening console session...";
            StateHasChanged();

            string sessionId = await ConsoleSessionService.CreateSessionAsync(
                nodeName,
                _vm.VmId,
                CurrentUserId!,
                default);

            if (string.IsNullOrWhiteSpace(sessionId))
            {
                _consoleError = "Console session id is empty.";
                return;
            }

            _currentConsoleSessionId = sessionId;

            ConsoleSession? session = ConsoleSessionService.GetSession(sessionId);
            if (session == null)
            {
                _consoleError = "Console session could not be retrieved.";
                return;
            }

            string vncTicket = session.Ticket;
            if (string.IsNullOrEmpty(vncTicket))
            {
                _consoleError = "VNC ticket is empty.";
                return;
            }

            _consoleStatus = "Console session created. Connecting noVNC...";
            StateHasChanged();

            await JS.InvokeVoidAsync(
                "vmConsole.openConsoleWithNoVnc",
                "vnc-iframe",
                _currentConsoleSessionId,
                vncTicket);

            _consoleStatus = "Console connected (noVNC running in iframe).";
        }
        catch (Exception ex)
        {
            _consoleError = "An error occurred while opening the console: " + ex.Message;
        }
        finally
        {
            _consoleOpening = false;
            StateHasChanged();
        }
    }

    private void StartStatusRefreshLoop()
    {
        _statusRefreshCts?.Cancel();
        _statusRefreshCts = new CancellationTokenSource();
        CancellationToken token = _statusRefreshCts.Token;

        _ = Task.Run(async () =>
        {
            try
            {
                using PeriodicTimer timer = new PeriodicTimer(TimeSpan.FromSeconds(5));

                while (await timer.WaitForNextTickAsync(token))
                {
                    if (token.IsCancellationRequested)
                    {
                        break;
                    }

                    await InvokeAsync(async () =>
                    {
                        try
                        {
                            // Do not refresh while console is active/opening
                            if (_consoleOpening || !string.IsNullOrEmpty(_currentConsoleSessionId))
                            {
                                return;
                            }

                            await RefreshStatusInternalAsync(false);
                        }
                        catch (Exception ex)
                        {
                            Logger.LogError(ex, "Periodic status refresh failed for VM {VmId}", Id);
                        }
                    });
                }
            }
            catch (OperationCanceledException)
            {
                // ignore cancellation
            }
        }, token);
    }

    public async ValueTask DisposeAsync()
    {
        if (_statusRefreshCts != null)
        {
            _statusRefreshCts.Cancel();
            _statusRefreshCts.Dispose();
            _statusRefreshCts = null;
        }

        if (_messageCts != null)
        {
            _messageCts.Cancel();
            _messageCts.Dispose();
            _messageCts = null;
        }

        await Task.CompletedTask;
    }


    private int GetCpuUsagePercent()
    {
        if (_vm == null || _effectiveMaxCpuCores <= 0)
        {
            return 0;
        }

        double ratio = (double)_vm.CpuCores / _effectiveMaxCpuCores;
        int pct = (int)Math.Round(100.0 * ratio);
        return Math.Max(0, Math.Min(100, pct));
    }

    private int GetMemoryUsagePercent()
    {
        if (_vm == null || _effectiveMaxMemoryMiB <= 0)
        {
            return 0;
        }

        double ratio = (double)_vm.MemoryMiB / _effectiveMaxMemoryMiB;
        int pct = (int)Math.Round(100.0 * ratio);
        return Math.Max(0, Math.Min(100, pct));
    }

    private int GetDiskUsagePercent()
    {
        if (_vm == null || _effectiveMaxDiskGiB <= 0)
        {
            return 0;
        }

        double ratio = (double)_vm.DiskGiB / _effectiveMaxDiskGiB;
        int pct = (int)Math.Round(100.0 * ratio);
        return Math.Max(0, Math.Min(100, pct));
    }


    private async Task LoadPermissionsAsync()
    {
        _canDelete = false;
        _canManageResources = false;
        _primaryOwnerName = null;
        _vmPermissions.Clear();
        _permissionError = null;

        if (_vm == null || string.IsNullOrEmpty(CurrentUserId))
        {
            return;
        }

        // Resolve current user DB record
        VmPortal.Domain.Users.User? currentUser =
            await Db.Users.FirstOrDefaultAsync(u => u.ExternalId == CurrentUserId);

        if (currentUser == null)
        {
            return;
        }

        Guid currentUserDbId = currentUser.Id;

        // Load primary owner name for display
        if (_vm.OwnerUserId != Guid.Empty)
        {
            VmPortal.Domain.Users.User? owner =
                await Db.Users.FirstOrDefaultAsync(u => u.Id == _vm.OwnerUserId);

            if (owner != null)
            {
                if (!string.IsNullOrWhiteSpace(owner.DisplayName))
                {
                    _primaryOwnerName = owner.DisplayName;
                }
                else if (!string.IsNullOrWhiteSpace(owner.Email))
                {
                    _primaryOwnerName = owner.Email;
                }
                else if (!string.IsNullOrWhiteSpace(owner.ExternalId))
                {
                    _primaryOwnerName = owner.ExternalId;
                }
                else
                {
                    _primaryOwnerName = "Owner";
                }
            }
        }

        // Permissions for current user (non-admin)
        if (_vm.OwnerUserId == currentUserDbId)
        {
            _canDelete = true;
            _canManageResources = true;
        }
        else
        {
            VmUserPermission? perm = await Db.VmUserPermissions
                .FirstOrDefaultAsync(p => p.VmId == _vm.Id && p.UserId == currentUserDbId);

            if (perm != null)
            {
                _canDelete = perm.CanDelete;
                _canManageResources = perm.CanManageResources;
            }
        }

        // Load all permissions for display (admin card)
        List<VmUserPermission> perms = await Db.VmUserPermissions
            .Where(p => p.VmId == _vm.Id)
            .ToListAsync();

        if (perms.Count > 0)
        {
            List<Guid> userIds = perms.Select(p => p.UserId).Distinct().ToList();
            List<VmPortal.Domain.Users.User> users = await Db.Users
                .Where(u => userIds.Contains(u.Id))
                .ToListAsync();

            Dictionary<Guid, VmPortal.Domain.Users.User> userIndex =
                users.ToDictionary(u => u.Id);

            foreach (VmUserPermission p in perms)
            {
                if (!userIndex.TryGetValue(p.UserId, out VmPortal.Domain.Users.User? u) || u == null)
                {
                    continue;
                }

                VmPermissionDisplay display = new VmPermissionDisplay
                {
                    PermissionId = p.Id,
                    UserId = p.UserId,
                    UserDisplayName = !string.IsNullOrWhiteSpace(u.DisplayName)
                        ? u.DisplayName
                        : (u.Email ?? string.Empty),
                    UserEmail = u.Email ?? string.Empty,
                    CanDelete = p.CanDelete,
                    CanManageResources = p.CanManageResources
                };

                _vmPermissions.Add(display);
            }
        }
    }

    private string? _primaryOwnerName;

    private sealed class VmPermissionDisplay
    {
        public Guid PermissionId { get; set; }
        public Guid UserId { get; set; }
        public string UserDisplayName { get; set; } = string.Empty;
        public string UserEmail { get; set; } = string.Empty;
        public bool CanDelete { get; set; }
        public bool CanManageResources { get; set; }
    }

    private List<VmPermissionDisplay> _vmPermissions = new List<VmPermissionDisplay>();

    private string _newPermissionUserInput = string.Empty;
    private string? _permissionError;
    private bool _permissionsBusy;


    private async Task AddPermissionAsync()
    {
        if (_vm == null || string.IsNullOrWhiteSpace(_newPermissionUserInput))
        {
            _permissionError = "Please enter an email or display name.";
            return;
        }

        _permissionsBusy = true;
        _permissionError = null;
        StateHasChanged();

        try
        {
            string query = _newPermissionUserInput.Trim();

            // Find user by email first, then by DisplayName
            VmPortal.Domain.Users.User? user =
                await Db.Users.FirstOrDefaultAsync(u => u.Email == query);

            if (user == null)
            {
                user = await Db.Users.FirstOrDefaultAsync(u => u.DisplayName == query);
            }

            if (user == null)
            {
                _permissionError = "No user found with that email or display name.";
                return;
            }

            if (user.Id == _vm.OwnerUserId)
            {
                _permissionError = "The primary owner already has full access.";
                return;
            }

            bool alreadyExists = await Db.VmUserPermissions
                .AnyAsync(p => p.VmId == _vm.Id && p.UserId == user.Id);

            if (alreadyExists)
            {
                _permissionError = "This user already has permissions for this VM.";
                return;
            }

            VmUserPermission perm = new VmUserPermission
            {
                Id = Guid.NewGuid(),
                VmId = _vm.Id,
                UserId = user.Id,
                IsPrimaryOwner = false,
                CanDelete = false,
                CanManageResources = false,
                CreatedAt = DateTimeOffset.UtcNow
            };

            Db.VmUserPermissions.Add(perm);
            await Db.SaveChangesAsync();

            _newPermissionUserInput = string.Empty;
            await LoadPermissionsAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to add VM permission for VM {VmId}", _vm.Id);
            _permissionError = "Failed to add user permission.";
        }
        finally
        {
            _permissionsBusy = false;
            StateHasChanged();
        }
    }

    private async Task ToggleDeletePermissionAsync(Guid permissionId)
    {
        if (_vm == null)
        {
            return;
        }

        VmUserPermission? perm = await Db.VmUserPermissions
            .FirstOrDefaultAsync(p => p.Id == permissionId && p.VmId == _vm.Id);

        if (perm == null)
        {
            return;
        }

        perm.CanDelete = !perm.CanDelete;
        await Db.SaveChangesAsync();
        await LoadPermissionsAsync();
    }

    private async Task ToggleManagePermissionAsync(Guid permissionId)
    {
        if (_vm == null)
        {
            return;
        }

        VmUserPermission? perm = await Db.VmUserPermissions
            .FirstOrDefaultAsync(p => p.Id == permissionId && p.VmId == _vm.Id);

        if (perm == null)
        {
            return;
        }

        perm.CanManageResources = !perm.CanManageResources;
        await Db.SaveChangesAsync();
        await LoadPermissionsAsync();
    }

    private async Task RemovePermissionAsync(Guid permissionId)
    {
        if (_vm == null)
        {
            return;
        }

        VmUserPermission? perm = await Db.VmUserPermissions
            .FirstOrDefaultAsync(p => p.Id == permissionId && p.VmId == _vm.Id);

        if (perm == null)
        {
            return;
        }

        Db.VmUserPermissions.Remove(perm);
        await Db.SaveChangesAsync();
        await LoadPermissionsAsync();
    }

    private async Task DeleteVmAsync()
    {
        if (_vm == null || _busy || _vm.VmId <= 0)
        {
            return;
        }

        bool confirm = await JS.InvokeAsync<bool>(
            "confirm",
            $"Are you sure you want to delete VM '{_vm.Name}' (ID {_vm.VmId})? This will disable it and schedule it for deletion.");
        if (!confirm)
        {
            return;
        }

        _busy = true;
        ClearMessage();
        StateHasChanged();

        try
        {
            DateTimeOffset now = DateTimeOffset.UtcNow;

            _vm.IsDisabled = true;
            _vm.DisabledAt = now;
            await Db.SaveChangesAsync();

            await LogSecurityEventAsync(
                "VmDisableRequestedByUser",
                $"VM: {Sanitizer.SanitizeForLog(_vm.Name)} ({_vm.VmId}) disabled and scheduled for deletion by user {CurrentUserId}",
                "Information");

            ShowMessage(
                "VM has been disabled and scheduled for deletion. It may remain in Proxmox until cleanup runs.",
                false);

            await Task.Delay(1500);
            Nav.NavigateTo("/my-vms");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to disable VM {VmId} for user {UserId}", _vm.VmId, CurrentUserId);
            await LogSecurityEventAsync(
                "VmDisableFailed",
                $"VM: {Sanitizer.SanitizeForLog(_vm.Name)} ({_vm.VmId}), Error: {ex.Message}",
                "Error");
            ShowMessage("Failed to disable VM. Please try again or contact support.", true);
        }
        finally
        {
            _busy = false;
            StateHasChanged();
        }
    }

}
