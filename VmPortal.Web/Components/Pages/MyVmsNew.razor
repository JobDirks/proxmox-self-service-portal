@page "/my-vms/new"
@rendermode InteractiveServer
@using System
@using System.Linq
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inherits SecureComponentBase
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Domain.Users
@using VmPortal.Application.Security
@using VmPortal.Application.Proxmox
@using VmPortal.Application.Vms
@inject VmPortalDbContext Db
@inject IInputSanitizer Sanitizer
@inject NavigationManager Nav
@inject IProxmoxClient Proxmox
@inject Microsoft.Extensions.Options.IOptions<VmResourceLimitsOptions> VmLimitsOptions
@inject Microsoft.Extensions.Options.IOptions<ProxmoxTagOptions> ProxmoxTagOptions

<PageTitle>Create VM</PageTitle>

<h1 class="h3 mb-3">Create Virtual Machine</h1>

@if (_loading)
{
    <div class="d-flex justify-content-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (!string.IsNullOrEmpty(_loadError))
{
    <div class="alert alert-danger">
        <h4 class="alert-heading h6"><i class="fas fa-exclamation-triangle me-1"></i> Cannot create VMs</h4>
        <p class="mb-0">@_loadError</p>
    </div>
}
else if (_templates.Count == 0)
{
    <div class="alert alert-info">
        <h4 class="alert-heading h6"><i class="fas fa-info-circle me-1"></i> No Templates Available</h4>
        <p class="mb-0">No VM templates are defined. Contact your administrator.</p>
    </div>
}
else
{
    <div class="row">
        <div class="col-lg-8">
            <div class="card mb-3">
                <div class="card-header">
                    <h5 class="mb-0">VM Configuration</h5>
                </div>
                <div class="card-body">
                    @if (_stage != CreateVmStage.None)
                    {
                        <div class="mb-3">
                            <strong>Provisioning steps</strong>
                            <ol class="mt-2 small">
                                <li class="@GetStepCss(CreateVmStage.Validating)">
                                    Validate configuration
                                </li>
                                <li class="@GetStepCss(CreateVmStage.Cloning)">
                                    Clone VM in Proxmox
                                </li>
                                <li class="@GetStepCss(CreateVmStage.ConfiguringResources)">
                                    Configure CPU and memory
                                </li>
                                <li class="@GetStepCss(CreateVmStage.ResizingDisk)">
                                    Resize disk (if needed)
                                </li>
                                <li class="@GetStepCss(CreateVmStage.SavingToDatabase)">
                                    Save VM in portal database
                                </li>
                            </ol>
                        </div>

                        @if (!string.IsNullOrEmpty(_stageMessage))
                        {
                            <div class="alert @( _stage == CreateVmStage.Failed ? "alert-danger" : "alert-info" ) py-2 mb-3">
                                @_stageMessage
                            </div>
                        }
                    }

                    @if (!string.IsNullOrEmpty(_formError))
                    {
                        <div class="alert alert-warning py-2 mb-3">
                            @_formError
                        </div>
                    }

                    <EditForm Model="_model"
                              OnValidSubmit="CreateVmAsync">
                        <DataAnnotationsValidator />
                        <ValidationSummary />

                        <fieldset disabled="@_saving">
                            <div class="mb-3">
                                <label class="form-label">Template</label>
                                <InputSelect class="form-select"
                                             @bind-Value="_model.TemplateId"
                                             @onchange="OnTemplateChanged">
                                    <option value="">-- Select Template --</option>
                                    @foreach (VmTemplate template in _templates)
                                    {
                                        <option value="@template.Id">
                                            @template.Name (@template.Node / @template.TemplateVmId)
                                        </option>
                                    }
                                </InputSelect>
                                <div class="form-text small">
                                    Choose the base template to clone from.
                                </div>
                            </div>

                            <div class="mb-3">
                                <label class="form-label">VM Name</label>
                                <input class="form-control"
                                       @bind="_model.Name"
                                       @bind:event="oninput" />
                                <div class="form-text small">
                                    Use a DNS-compatible name: letters, numbers, '-' and '.', no spaces.
                                </div>
                                @{
                                    string? nameError = GetNameError();
                                    if (!string.IsNullOrEmpty(nameError))
                                    {
                                        <div class="text-danger small">@nameError</div>
                                    }
                                }
                            </div>

                            <div class="row mb-3">
                                <div class="col-4">
                                    <label class="form-label">CPU Cores</label>
                                    <InputNumber class="form-control" @bind-Value="_model.CpuCores" />
                                    @{
                                        string? cpuError = GetCpuError();
                                        if (!string.IsNullOrEmpty(cpuError))
                                        {
                                            <div class="text-danger small">@cpuError</div>
                                        }
                                        else
                                        {
                                            VmTemplate? t = GetCurrentTemplate();
                                            if (t != null)
                                            {
                                                int? effMaxCpu = GetEffectiveTemplateMaxCpu(t);
                                                <div class="form-text small">
                                                    Default: @t.DefaultCpuCores,
                                                    Max: @(effMaxCpu?.ToString() ?? _vmLimits.MaxCpuCores.ToString())
                                                </div>
                                            }
                                        }
                                    }
                                </div>
                                <div class="col-4">
                                    <label class="form-label">RAM (MiB)</label>
                                    <InputNumber class="form-control" @bind-Value="_model.MemoryMiB" />
                                    @{
                                        string? memError = GetMemoryError();
                                        if (!string.IsNullOrEmpty(memError))
                                        {
                                            <div class="text-danger small">@memError</div>
                                        }
                                        else
                                        {
                                            VmTemplate? t = GetCurrentTemplate();
                                            if (t != null)
                                            {
                                                int? effMaxMem = GetEffectiveTemplateMaxMemory(t);
                                                <div class="form-text small">
                                                    Default: @t.DefaultMemoryMiB MiB,
                                                    Max: @(effMaxMem?.ToString() ?? _vmLimits.MaxMemoryMiB.ToString()) MiB
                                                </div>
                                            }
                                        }
                                    }
                                </div>
                                <div class="col-4">
                                    <label class="form-label">Disk (GiB)</label>
                                    <InputNumber class="form-control" @bind-Value="_model.DiskGiB" />
                                    @{
                                        string? diskError = GetDiskError();
                                        if (!string.IsNullOrEmpty(diskError))
                                        {
                                            <div class="text-danger small">@diskError</div>
                                        }
                                        else
                                        {
                                            VmTemplate? t = GetCurrentTemplate();
                                            if (t != null)
                                            {
                                                int? effMaxDisk = GetEffectiveTemplateMaxDisk(t);
                                                <div class="form-text small">
                                                    Default: @t.DefaultDiskGiB GiB,
                                                    Max: @(effMaxDisk?.ToString() ?? _vmLimits.MaxDiskGiB.ToString()) GiB
                                                </div>
                                            }
                                        }
                                    }
                                </div>
                            </div>

                            <button type="submit" class="btn btn-primary" disabled="@_saving">
                                @if (_saving)
                                {
                                    <span class="spinner-border spinner-border-sm me-2"></span>
                                }
                                Create VM
                            </button>
                            <button type="button" class="btn btn-secondary ms-2" @onclick="Cancel" disabled="@_saving">
                                Cancel
                            </button>
                        </fieldset>
                    </EditForm>
                </div>
            </div>
        </div>
    </div>
}

@code {
    private enum CreateVmStage
    {
        None = 0,
        Validating = 1,
        Cloning = 2,
        ConfiguringResources = 3,
        ResizingDisk = 4,
        SavingToDatabase = 5,
        Completed = 6,
        Failed = 7
    }

    private List<VmTemplate> _templates = new List<VmTemplate>();
    private CreateVmModel _model = new CreateVmModel();
    private bool _loading = true;
    private bool _saving = false;
    private Guid _currentUserDbId;
    private string? _formError;
    private string? _loadError;
    private VmResourceLimitsOptions _vmLimits = new VmResourceLimitsOptions();
    private CreateVmStage _stage = CreateVmStage.None;
    private string? _stageMessage;

    private ProxmoxTagOptions _tagOptions = new ProxmoxTagOptions();

    private sealed class CreateVmModel
    {
        public Guid? TemplateId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int CpuCores { get; set; } = 2;
        public int MemoryMiB { get; set; } = 2048;
        public int DiskGiB { get; set; } = 20;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _vmLimits = VmLimitsOptions.Value;
        _tagOptions = ProxmoxTagOptions.Value;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            if (string.IsNullOrEmpty(CurrentUserId))
            {
                _loadError = "Current user identity was not resolved.";
                _loading = false;
                return;
            }

            User? user = await Db.Users.FirstOrDefaultAsync(u => u.ExternalId == CurrentUserId);
            if (user == null)
            {
                _loadError = "No user record found for the current identity. Contact an administrator.";
                _loading = false;
                return;
            }

            _currentUserDbId = user.Id;

            _templates = await Db.VmTemplates
                .Where(t => t.IsActive)
                .OrderBy(t => t.Name)
                .ToListAsync();

            _loading = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load templates for user {UserId}", CurrentUserId);
            await LogSecurityEventAsync("VmCreateLoadFailed", ex.Message, "Error");
            _loadError = "Failed to load templates. Please try again later.";
            _loading = false;
        }
    }

    private VmTemplate? GetCurrentTemplate()
    {
        if (_model.TemplateId == null)
        {
            return null;
        }

        Guid id = _model.TemplateId.Value;
        VmTemplate? template = _templates.FirstOrDefault(t => t.Id == id);
        return template;
    }

    private async Task OnTemplateChanged(ChangeEventArgs args)
    {
        if (args.Value == null)
        {
            return;
        }

        string value = args.Value.ToString() ?? string.Empty;

        if (!Guid.TryParse(value, out Guid templateId))
        {
            return;
        }

        _model.TemplateId = templateId;

        VmTemplate? template = _templates.FirstOrDefault(t => t.Id == templateId);
        if (template != null)
        {
            _model.CpuCores = template.DefaultCpuCores;
            _model.MemoryMiB = template.DefaultMemoryMiB;
            _model.DiskGiB = template.DefaultDiskGiB;
        }

        _formError = null;
        _stage = CreateVmStage.None;
        _stageMessage = null;

        await InvokeAsync(StateHasChanged);
    }

    private string? GetNameError()
    {
        return ValidateDnsName(_model.Name);
    }

    private string? ValidateDnsName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "VM name is required.";
        }

        string trimmed = name.Trim();

        for (int i = 0; i < trimmed.Length; i++)
        {
            char ch = trimmed[i];
            if (!char.IsLetterOrDigit(ch) && ch != '-' && ch != '.')
            {
                return "VM name must be DNS-compatible: letters, numbers, '-' and '.', no spaces.";
            }
        }

        if (trimmed.StartsWith("-", StringComparison.Ordinal) ||
            trimmed.EndsWith("-", StringComparison.Ordinal) ||
            trimmed.StartsWith(".", StringComparison.Ordinal) ||
            trimmed.EndsWith(".", StringComparison.Ordinal))
        {
            return "VM name must not start or end with '-' or '.'.";
        }

        return null;
    }

    // Helper: compute effective template max = min(global, template.MaxX)
    private int? GetEffectiveTemplateMaxCpu(VmTemplate template)
    {
        int global = _vmLimits.MaxCpuCores > 0 ? _vmLimits.MaxCpuCores : int.MaxValue;
        if (template.MaxCpuCores.HasValue)
        {
            return Math.Min(global, template.MaxCpuCores.Value);
        }

        if (global == int.MaxValue)
        {
            return null;
        }

        return global;
    }

    private int? GetEffectiveTemplateMaxMemory(VmTemplate template)
    {
        int global = _vmLimits.MaxMemoryMiB > 0 ? _vmLimits.MaxMemoryMiB : int.MaxValue;
        if (template.MaxMemoryMiB.HasValue)
        {
            return Math.Min(global, template.MaxMemoryMiB.Value);
        }

        if (global == int.MaxValue)
        {
            return null;
        }

        return global;
    }

    private int? GetEffectiveTemplateMaxDisk(VmTemplate template)
    {
        int global = _vmLimits.MaxDiskGiB > 0 ? _vmLimits.MaxDiskGiB : int.MaxValue;
        if (template.MaxDiskGiB.HasValue)
        {
            return Math.Min(global, template.MaxDiskGiB.Value);
        }

        if (global == int.MaxValue)
        {
            return null;
        }

        return global;
    }

    private string? ValidateCpu(int cpuCores, VmTemplate template)
    {
        if (cpuCores <= 0)
        {
            return "CPU cores must be positive.";
        }

        if (cpuCores < template.DefaultCpuCores)
        {
            return $"CPU cores cannot be smaller than the template default ({template.DefaultCpuCores}).";
        }

        int? effMaxCpu = GetEffectiveTemplateMaxCpu(template);
        if (effMaxCpu.HasValue && cpuCores > effMaxCpu.Value)
        {
            return $"CPU cores cannot exceed the maximum ({effMaxCpu.Value}).";
        }

        return null;
    }

    private string? ValidateMemory(int memoryMiB, VmTemplate template)
    {
        if (memoryMiB <= 0)
        {
            return "Memory must be positive.";
        }

        if (memoryMiB < template.DefaultMemoryMiB)
        {
            return $"Memory cannot be smaller than the template default ({template.DefaultMemoryMiB} MiB).";
        }

        int? effMaxMem = GetEffectiveTemplateMaxMemory(template);
        if (effMaxMem.HasValue && memoryMiB > effMaxMem.Value)
        {
            return $"Memory cannot exceed the maximum ({effMaxMem.Value} MiB).";
        }

        return null;
    }

    private string? ValidateDisk(int diskGiB, VmTemplate template)
    {
        if (diskGiB <= 0)
        {
            return "Disk size must be positive.";
        }

        if (diskGiB < template.DefaultDiskGiB)
        {
            return $"Disk size cannot be smaller than the template default ({template.DefaultDiskGiB} GiB).";
        }

        int? effMaxDisk = GetEffectiveTemplateMaxDisk(template);
        if (effMaxDisk.HasValue && diskGiB > effMaxDisk.Value)
        {
            return $"Disk size cannot exceed the maximum ({effMaxDisk.Value} GiB).";
        }

        return null;
    }

    private string? GetCpuError()
    {
        VmTemplate? template = GetCurrentTemplate();
        if (template == null)
        {
            return null;
        }

        return ValidateCpu(_model.CpuCores, template);
    }

    private string? GetMemoryError()
    {
        VmTemplate? template = GetCurrentTemplate();
        if (template == null)
        {
            return null;
        }

        return ValidateMemory(_model.MemoryMiB, template);
    }

    private string? GetDiskError()
    {
        VmTemplate? template = GetCurrentTemplate();
        if (template == null)
        {
            return null;
        }

        return ValidateDisk(_model.DiskGiB, template);
    }

    private string GetStepCss(CreateVmStage step)
    {
        if (_stage == CreateVmStage.Failed)
        {
            if (step <= _stage)
            {
                return "fw-bold text-danger";
            }

            return "text-muted";
        }

        if (_stage >= CreateVmStage.Completed)
        {
            return "text-success";
        }

        if (step < _stage)
        {
            return "text-success";
        }

        if (step == _stage)
        {
            return "fw-bold text-primary";
        }

        return "text-muted";
    }

    private async Task CreateVmAsync()
    {
        if (_saving)
        {
            return;
        }

        _saving = true;
        _formError = null;
        _stage = CreateVmStage.Validating;
        _stageMessage = "Validating VM configuration...";
        StateHasChanged();

        try
        {
            if (_model.TemplateId == null)
            {
                _formError = "Please select a template.";
                await LogSecurityEventAsync("VmCreateValidationFailed", "TemplateId is null", "Warning");
                _stage = CreateVmStage.Failed;
                _stageMessage = "Validation failed: no template selected.";
                return;
            }

            VmTemplate? template = GetCurrentTemplate();
            if (template == null || !template.IsActive)
            {
                _formError = "Selected template is not available.";
                await LogSecurityEventAsync("VmCreateValidationFailed", "Template not found or inactive", "Warning");
                _stage = CreateVmStage.Failed;
                _stageMessage = "Validation failed: template not available.";
                return;
            }

            string name = Sanitizer.SanitizeVmName(_model.Name);
            string? dnsError = ValidateDnsName(name);
            if (!string.IsNullOrEmpty(dnsError))
            {
                _formError = dnsError;
                await LogSecurityEventAsync("VmCreateValidationFailed", $"Invalid VM name: {dnsError}", "Warning");
                _stage = CreateVmStage.Failed;
                _stageMessage = "Validation failed: VM name is not DNS-compatible.";
                return;
            }

            string? cpuError = ValidateCpu(_model.CpuCores, template);
            if (!string.IsNullOrEmpty(cpuError))
            {
                _formError = cpuError;
                await LogSecurityEventAsync("VmCreateValidationFailed", cpuError, "Warning");
                _stage = CreateVmStage.Failed;
                _stageMessage = "Validation failed: CPU configuration invalid.";
                return;
            }

            string? memError = ValidateMemory(_model.MemoryMiB, template);
            if (!string.IsNullOrEmpty(memError))
            {
                _formError = memError;
                await LogSecurityEventAsync("VmCreateValidationFailed", memError, "Warning");
                _stage = CreateVmStage.Failed;
                _stageMessage = "Validation failed: memory configuration invalid.";
                return;
            }

            string? diskError = ValidateDisk(_model.DiskGiB, template);
            if (!string.IsNullOrEmpty(diskError))
            {
                _formError = diskError;
                await LogSecurityEventAsync("VmCreateValidationFailed", diskError, "Warning");
                _stage = CreateVmStage.Failed;
                _stageMessage = "Validation failed: disk configuration invalid.";
                return;
            }

            _stage = CreateVmStage.Cloning;
            _stageMessage = "Cloning VM in Proxmox...";
            StateHasChanged();

            ProxmoxCloneResult cloneResult;
            try
            {
                cloneResult = await Proxmox.CloneVmAsync(
                    template.Node,
                    template.TemplateVmId,
                    name,
                    _model.CpuCores,
                    _model.MemoryMiB,
                    _model.DiskGiB,
                    default);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Proxmox clone failed for template {TemplateVmId} on node {Node}", template.TemplateVmId, template.Node);
                await LogSecurityEventAsync("VmCloneFailed",
                    $"Template: {template.Name} ({template.TemplateVmId}), Error: {ex.Message}",
                    "Error");
                _formError = "Failed to start VM creation in Proxmox. Please try again or contact an administrator.";
                _stage = CreateVmStage.Failed;
                _stageMessage = "Proxmox clone failed.";
                return;
            }

            int newVmId = cloneResult.VmId;

            try
            {
                IEnumerable<string> tags = BuildCloneVmTags(template);
                await Proxmox.SetVmTagsAsync(template.Node, newVmId, tags, default);
            }
            catch (Exception tagEx)
            {
                Logger.LogError(tagEx, "Failed to apply tags to cloned VM {VmId} on node {Node}", newVmId, template.Node);
                await LogSecurityEventAsync(
                    "VmTaggingFailed",
                    $"Template: {template.Name} ({template.TemplateVmId}), New VM: {name}, Error: {tagEx.Message}",
                    "Warning");
            }

            await LogSecurityEventAsync("VmCloneRequested",
                $"Template: {template.Name} ({template.TemplateVmId}), New VM: {name}, TaskId: {cloneResult.TaskId}, VmId: {newVmId}",
                "Information");

            _stage = CreateVmStage.ConfiguringResources;
            _stageMessage = "Configuring CPU and memory...";
            StateHasChanged();

            try
            {
                await Proxmox.ConfigureVmResourcesAsync(
                    template.Node,
                    newVmId,
                    _model.CpuCores,
                    _model.MemoryMiB,
                    default);

                await LogSecurityEventAsync("VmConfigUpdated",
                    $"VM: {name} ({newVmId}), CPU: {_model.CpuCores}, RAM: {_model.MemoryMiB} MiB",
                    "Information");
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Proxmox config failed for VM {VmId} on node {Node}", newVmId, template.Node);
                await LogSecurityEventAsync("VmConfigFailed",
                    $"VM: {name} ({newVmId}), Error: {ex.Message}",
                    "Warning");
            }

            _stage = CreateVmStage.ResizingDisk;
            _stageMessage = "Resizing disk (if needed)...";
            StateHasChanged();

            try
            {
                int requestedDiskGiB = _model.DiskGiB;
                int templateDiskGiB = template.DefaultDiskGiB;

                if (requestedDiskGiB > templateDiskGiB)
                {
                    await Proxmox.ResizeVmDiskAsync(
                        template.Node,
                        newVmId,
                        requestedDiskGiB,
                        default);

                    await LogSecurityEventAsync(
                        "VmDiskResized",
                        $"VM: {name} ({newVmId}), Disk: {requestedDiskGiB} GiB (from template {templateDiskGiB} GiB)",
                        "Information");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Proxmox disk resize failed for VM {VmId} on node {Node}", newVmId, template.Node);
                await LogSecurityEventAsync(
                    "VmDiskResizeFailed",
                    $"VM: {name} ({newVmId}), Requested Disk: {_model.DiskGiB} GiB, Error: {ex.Message}",
                    "Warning");
            }

            _stage = CreateVmStage.SavingToDatabase;
            _stageMessage = "Saving VM in portal database...";
            StateHasChanged();

            Vm vm = new Vm
            {
                Id = Guid.NewGuid(),
                VmId = newVmId,
                Node = template.Node,
                Name = name,
                Status = VmStatus.Stopped,

                CpuCores = _model.CpuCores,
                MemoryMiB = _model.MemoryMiB,
                DiskGiB = _model.DiskGiB,

                // Link back to template + copy max limits
                TemplateId = template.Id,
                TemplateVmId = template.TemplateVmId,
                MaxCpuCores = template.MaxCpuCores,
                MaxMemoryMiB = template.MaxMemoryMiB,
                MaxDiskGiB = template.MaxDiskGiB,

                LastSyncedAt = DateTimeOffset.UtcNow,
                OwnerUserId = _currentUserDbId
            };

            Db.Vms.Add(vm);
            await Db.SaveChangesAsync();

            await LogSecurityEventAsync("VmCreatedFromTemplate",
                $"Template: {template.Name} ({template.TemplateVmId}), VM: {name}, VmId: {newVmId}, CloneTaskId: {cloneResult.TaskId}",
                "Information");

            _stage = CreateVmStage.Completed;
            _stageMessage = "VM created successfully. Redirecting to My VMs...";
            StateHasChanged();

            await Task.Delay(1500);
            Nav.NavigateTo("/my-vms");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create VM from template for user {UserId}", CurrentUserId);
            await LogSecurityEventAsync("VmCreateFromTemplateFailed", ex.Message, "Error");
            _formError = "An unexpected error occurred while creating the VM.";
            _stage = CreateVmStage.Failed;
            _stageMessage = "VM creation failed due to an unexpected error.";
        }
        finally
        {
            _saving = false;
            StateHasChanged();
        }
    }

    private IEnumerable<string> BuildCloneVmTags(VmTemplate template)
        {
            List<string> tags = new List<string>();

            if (!string.IsNullOrWhiteSpace(_tagOptions.ManagedVmTag))
            {
                tags.Add(_tagOptions.ManagedVmTag);
            }

            if (!string.IsNullOrWhiteSpace(template.TemplateTagName) &&
                !string.IsNullOrWhiteSpace(_tagOptions.TemplateNameTagPrefix))
            {
                string tmplTag = _tagOptions.TemplateNameTagPrefix + template.TemplateTagName;
                tags.Add(tmplTag);
            }

            return tags;
        }

    private void Cancel()
        {
            Nav.NavigateTo("/my-vms");
        }
}
