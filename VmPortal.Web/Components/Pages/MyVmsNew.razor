@page "/my-vms/new"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inherits SecureComponentBase
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Domain.Users
@using VmPortal.Application.Security
@using VmPortal.Application.Proxmox
@inject VmPortalDbContext Db
@inject IInputSanitizer Sanitizer
@inject NavigationManager Nav
@inject IProxmoxClient Proxmox
@using VmPortal.Application.Vms
@inject Microsoft.Extensions.Options.IOptions<VmResourceLimitsOptions> VmLimitsOptions

<PageTitle>Create VM</PageTitle>

<h1>Create Virtual Machine</h1>

@if (_loading)
{
    <div class="d-flex justify-content-center py-4">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_templates.Count == 0)
{
    <div class="alert alert-info">
        <h4 class="alert-heading"><i class="fas fa-info-circle"></i> No Templates Available</h4>
        <p>No VM templates are defined. Contact your administrator.</p>
    </div>
}
else
{
    @if (!string.IsNullOrEmpty(_formError))
    {
        <div class="alert alert-warning">
            @_formError
        </div>
    }

    <EditForm Model="_model"
              OnValidSubmit="CreateVmAsync"
              FormName="CreateVmForm">
        <DataAnnotationsValidator />
        <ValidationSummary />

        <fieldset disabled="@_saving">
            <div class="mb-3">
                <label class="form-label">Template</label>
                <InputSelect class="form-select" @bind-Value="_model.TemplateId">
                    <option value="">-- Select Template --</option>
                    @foreach (VmTemplate template in _templates)
                    {
                        <option value="@template.Id">@template.Name (@template.Node / @template.TemplateVmId)</option>
                    }
                </InputSelect>
            </div>

            <div class="mb-3">
                <label class="form-label">VM Name</label>
                <input class="form-control"
                       @bind="_model.Name"
                       @bind:event="oninput" />
                <div class="form-text">
                    Use a DNS-compatible name: letters, numbers, '-' and '.', no spaces.
                </div>
                @{
                    string? nameError = GetNameError();
                    if (!string.IsNullOrEmpty(nameError))
                    {
                        <div class="text-danger">@nameError</div>
                    }
                }
            </div>

            <div class="row mb-3">
                <div class="col-4">
                    <label class="form-label">CPU Cores</label>
                    <InputNumber class="form-control" @bind-Value="_model.CpuCores" />
                </div>
                <div class="col-4">
                    <label class="form-label">RAM (MiB)</label>
                    <InputNumber class="form-control" @bind-Value="_model.MemoryMiB" />
                </div>
                <div class="col-4">
                    <label class="form-label">Disk (GiB)</label>
                    <InputNumber class="form-control" @bind-Value="_model.DiskGiB" />
                </div>
            </div>

            <button type="submit" class="btn btn-primary" disabled="@_saving">
                @if (_saving)
                {
                    <span class="spinner-border spinner-border-sm me-2"></span>
                }
                Create VM
            </button>
            <button type="button" class="btn btn-secondary ms-2" @onclick="Cancel" disabled="@_saving">
                Cancel
            </button>
        </fieldset>
    </EditForm>
}

@code {
    private List<VmTemplate> _templates = new List<VmTemplate>();
    private CreateVmModel _model = new CreateVmModel();
    private bool _loading = true;
    private bool _saving = false;
    private Guid _currentUserDbId;
    private string? _formError;
    private VmResourceLimitsOptions _vmLimits = new VmResourceLimitsOptions();

    private sealed class CreateVmModel
    {
        public Guid? TemplateId { get; set; }
        public string Name { get; set; } = string.Empty;
        public int CpuCores { get; set; } = 2;
        public int MemoryMiB { get; set; } = 2048;
        public int DiskGiB { get; set; } = 20;
    }

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        _vmLimits = VmLimitsOptions.Value;
        await LoadDataAsync();
    }

    private async Task LoadDataAsync()
    {
        try
        {
            if (string.IsNullOrEmpty(CurrentUserId))
            {
                _loading = false;
                return;
            }

            User? user = await Db.Users.FirstOrDefaultAsync(u => u.ExternalId == CurrentUserId);
            if (user == null)
            {
                _loading = false;
                return;
            }

            _currentUserDbId = user.Id;

            _templates = await Db.VmTemplates
                .Where(t => t.IsActive)
                .OrderBy(t => t.Name)
                .ToListAsync();

            _loading = false;
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load templates for user {UserId}", CurrentUserId);
            await LogSecurityEventAsync("VmCreateLoadFailed", ex.Message, "Error");
            _loading = false;
        }
    }

    private string? GetNameError()
    {
        return ValidateDnsName(_model.Name);
    }

    private string? ValidateDnsName(string name)
    {
        if (string.IsNullOrWhiteSpace(name))
        {
            return "VM name is required.";
        }

        string trimmed = name.Trim();

        for (int i = 0; i < trimmed.Length; i++)
        {
            char ch = trimmed[i];
            if (!char.IsLetterOrDigit(ch) && ch != '-' && ch != '.')
            {
                return "VM name must be DNS-compatible: letters, numbers, '-' and '.', no spaces.";
            }
        }

        if (trimmed.StartsWith("-", StringComparison.Ordinal) ||
            trimmed.EndsWith("-", StringComparison.Ordinal) ||
            trimmed.StartsWith(".", StringComparison.Ordinal) ||
            trimmed.EndsWith(".", StringComparison.Ordinal))
        {
            return "VM name must not start or end with '-' or '.'.";
        }

        return null;
    }

    private async Task CreateVmAsync()
    {
        if (_saving)
        {
            return;
        }

        _saving = true;
        _formError = null;

        try
        {
            if (_model.TemplateId == null)
            {
                _formError = "Please select a template.";
                await LogSecurityEventAsync("VmCreateValidationFailed", "TemplateId is null", "Warning");
                _saving = false;
                return;
            }

            VmTemplate? template = await Db.VmTemplates.FirstOrDefaultAsync(t => t.Id == _model.TemplateId.Value);
            if (template == null || !template.IsActive)
            {
                _formError = "Selected template is not available.";
                await LogSecurityEventAsync("VmCreateValidationFailed", "Template not found or inactive", "Warning");
                _saving = false;
                return;
            }

            // Sanitize and validate name
            string name = Sanitizer.SanitizeVmName(_model.Name);
            string? dnsError = ValidateDnsName(name);
            if (!string.IsNullOrEmpty(dnsError))
            {
                _formError = dnsError;
                await LogSecurityEventAsync("VmCreateValidationFailed", $"Invalid VM name: {dnsError}", "Warning");
                _saving = false;
                return;
            }

            if (_model.CpuCores <= 0 || _model.MemoryMiB <= 0 || _model.DiskGiB <= 0)
            {
                _formError = "CPU, RAM and Disk must be positive values.";
                await LogSecurityEventAsync("VmCreateValidationFailed", "Invalid resource values", "Warning");
                _saving = false;
                return;
            }

            // Disk size must not be smaller than template default
            if (_model.DiskGiB < template.DefaultDiskGiB)
            {
                _formError = $"Disk size cannot be smaller than the template default ({template.DefaultDiskGiB} GiB).";
                await LogSecurityEventAsync(
                    "VmCreateValidationFailed",
                    $"Requested disk {_model.DiskGiB} GiB smaller than template default {template.DefaultDiskGiB} GiB",
                    "Warning");
                _saving = false;
                return;
            }

            // Disk size must not exceed configured maximum
            if (_vmLimits.MaxDiskGiB > 0 && _model.DiskGiB > _vmLimits.MaxDiskGiB)
            {
                _formError = $"Disk size cannot exceed the configured maximum ({_vmLimits.MaxDiskGiB} GiB).";
                await LogSecurityEventAsync(
                    "VmCreateValidationFailed",
                    $"Requested disk {_model.DiskGiB} GiB exceeds max {_vmLimits.MaxDiskGiB} GiB",
                    "Warning");
                _saving = false;
                return;
            }

            // Step 1: clone
            ProxmoxCloneResult cloneResult;
            try
            {
                cloneResult = await Proxmox.CloneVmAsync(
                    template.Node,
                    template.TemplateVmId,
                    name,
                    _model.CpuCores,
                    _model.MemoryMiB,
                    _model.DiskGiB,
                    default);
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Proxmox clone failed for template {TemplateVmId} on node {Node}", template.TemplateVmId, template.Node);
                await LogSecurityEventAsync("VmCloneFailed",
                    $"Template: {template.Name} ({template.TemplateVmId}), Error: {ex.Message}",
                    "Error");
                _formError = "Failed to start VM creation in Proxmox. Please try again or contact an administrator.";
                _saving = false;
                return;
            }

            int newVmId = cloneResult.VmId;

            await LogSecurityEventAsync("VmCloneRequested",
                $"Template: {template.Name} ({template.TemplateVmId}), New VM: {name}, TaskId: {cloneResult.TaskId}, VmId: {newVmId}",
                "Information");

            // Step 2: configure CPU/RAM
            try
            {
                int requestedDiskGiB = _model.DiskGiB;
                int templateDiskGiB = template.DefaultDiskGiB;

                if (requestedDiskGiB > templateDiskGiB)
                {
                    await Proxmox.ResizeVmDiskAsync(
                        template.Node,
                        newVmId,
                        requestedDiskGiB,   // absolute new size
                        default);

                    await LogSecurityEventAsync(
                        "VmDiskResized",
                        $"VM: {name} ({newVmId}), Disk: {requestedDiskGiB} GiB (from template {templateDiskGiB} GiB)",
                        "Information");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Proxmox disk resize failed for VM {VmId} on node {Node}", newVmId, template.Node);
                await LogSecurityEventAsync(
                    "VmDiskResizeFailed",
                    $"VM: {name} ({newVmId}), Requested Disk: {_model.DiskGiB} GiB, Error: {ex.Message}",
                    "Warning");
                // Continue; VM exists with template disk size.
            }

            try
            {
                int requestedDiskGiB = _model.DiskGiB;
                int templateDiskGiB = template.DefaultDiskGiB;

                if (requestedDiskGiB > templateDiskGiB)
                {
                    await Proxmox.ResizeVmDiskAsync(
                        template.Node,
                        newVmId,
                        requestedDiskGiB,
                        default);

                    await LogSecurityEventAsync(
                        "VmDiskResized",
                        $"VM: {name} ({newVmId}), Disk: {requestedDiskGiB} GiB (from template {templateDiskGiB} GiB)",
                        "Information");
                }
            }
            catch (Exception ex)
            {
                Logger.LogError(ex, "Proxmox disk resize failed for VM {VmId} on node {Node}", newVmId, template.Node);
                await LogSecurityEventAsync(
                    "VmDiskResizeFailed",
                    $"VM: {name} ({newVmId}), Requested Disk: {_model.DiskGiB} GiB, Error: {ex.Message}",
                    "Warning");
                // Continue; VM exists with template disk size.
            }


            // Step 3: insert DB record with real VmId
            Vm vm = new Vm
            {
                Id = Guid.NewGuid(),
                VmId = newVmId,
                Node = template.Node,
                Name = name,
                Status = VmStatus.Stopped,
                CpuCores = _model.CpuCores,
                MemoryMiB = _model.MemoryMiB,
                DiskGiB = _model.DiskGiB,
                LastSyncedAt = DateTimeOffset.UtcNow,
                OwnerUserId = _currentUserDbId
            };

            Db.Vms.Add(vm);
            await Db.SaveChangesAsync();

            await LogSecurityEventAsync("VmCreatedFromTemplate",
                $"Template: {template.Name} ({template.TemplateVmId}), VM: {name}, VmId: {newVmId}, CloneTaskId: {cloneResult.TaskId}",
                "Information");

            Nav.NavigateTo("/my-vms");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to create VM from template for user {UserId}", CurrentUserId);
            await LogSecurityEventAsync("VmCreateFromTemplateFailed", ex.Message, "Error");
            _formError = "An unexpected error occurred while creating the VM.";
            _saving = false;
        }
    }

    private void Cancel()
    {
        Nav.NavigateTo("/my-vms");
    }
}
