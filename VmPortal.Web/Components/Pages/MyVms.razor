@page "/my-vms"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@attribute [Authorize]
@inherits SecureComponentBase
@using Microsoft.EntityFrameworkCore
@using VmPortal.Infrastructure.Data
@using VmPortal.Domain.Vms
@using VmPortal.Domain.Users
@using VmPortal.Domain.Actions
@using VmPortal.Application.Proxmox
@using VmPortal.Application.Security
@inject VmPortalDbContext Db
@inject IProxmoxClient Proxmox
@inject IRateLimitingService RateLimit
@inject IInputSanitizer Sanitizer

<PageTitle>My Virtual Machines</PageTitle>

<div class="d-flex justify-content-between align-items-center mb-4">
    <h1>My Virtual Machines</h1>
    @if (_rateLimitCooldown.HasValue)
    {
        <div class="alert alert-warning mb-0">
            <i class="fas fa-clock"></i>
            Rate limit active. Try again in @_rateLimitCooldown.Value.Minutes minutes.
        </div>
    }
</div>

@if (_loading)
{
    <div class="d-flex justify-content-center py-5">
        <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">Loading...</span>
        </div>
    </div>
}
else if (_vms.Count == 0)
{
    <div class="alert alert-info">
        <h4 class="alert-heading"><i class="fas fa-info-circle"></i> No VMs Found</h4>
        <p>No virtual machines are currently linked to your account. Contact your administrator to have VMs assigned.</p>
    </div>
}
else
{
    <div class="table-responsive">
        <table class="table table-hover align-middle">
            <thead class="table-light">
                <tr>
                    <th>Name</th>
                    <th>Node</th>
                    <th>VM ID</th>
                    <th>Status</th>
                    <th>CPU</th>
                    <th>RAM (MiB)</th>
                    <th>Disk (GiB)</th>
                    <th>Last Synced</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody>
                @foreach (Vm vm in _vms)
                {
                    <tr class="@(_operationInProgress && _currentVm?.Id == vm.Id ? "table-primary" : string.Empty)">
                        <td>@Sanitizer.SanitizeForDisplay(vm.Name)</td>
                        <td>@Sanitizer.SanitizeForDisplay(vm.Node)</td>
                        <td>@vm.VmId</td>
                        <td>
                            <span class="badge @GetStatusBadgeClass(vm.Status)">
                                @if (_operationInProgress && _currentVm?.Id == vm.Id)
                                {
                                    <i class="spinner-border spinner-border-sm me-1" aria-hidden="true"></i>
                                }
                                @vm.Status
                            </span>
                        </td>
                        <td>@vm.CpuCores</td>
                        <td>@vm.MemoryMiB</td>
                        <td>@vm.DiskGiB</td>
                        <td>@vm.LastSyncedAt.ToString("MMM d, HH:mm")</td>
                        <td class="text-nowrap">
                            <button class="btn btn-sm btn-success me-1"
                                    disabled="@(_operationInProgress || vm.Status == VmStatus.Running || _rateLimitCooldown.HasValue || vm.VmId <= 0)"
                                    @onclick="() => StartVmAsync(vm)">
                                <i class="fas fa-play me-1"></i> Start
                            </button>

                            <button class="btn btn-sm btn-warning me-1"
                                    disabled="@(_operationInProgress || vm.Status != VmStatus.Running || _rateLimitCooldown.HasValue || vm.VmId <= 0)"
                                    @onclick="() => ShutdownVmAsync(vm)">
                                <i class="fas fa-power-off me-1"></i> Shutdown
                            </button>

                            <a class="btn btn-sm btn-outline-primary"
                               href="@($"/vm/{vm.Id}")"
                               title="View details">
                                <i class="fas fa-info-circle me-1"></i> Details
                            </a>
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
}

@if (_message != null)
{
    <div class="position-fixed top-0 end-0 p-3" style="z-index: 1100">
        <div class="toast show" role="alert">
            <div class="toast-header">
                <i class="fas @(_isError ? "fa-exclamation-triangle text-danger" : "fa-check-circle text-success")"></i>
                <strong class="me-auto ms-2">@(_isError ? "Error" : "Success")</strong>
                <button type="button" class="btn-close" @onclick="ClearMessage"></button>
            </div>
            <div class="toast-body">
                @_message
            </div>
        </div>
    </div>
}

@code {
    private List<Vm> _vms = new List<Vm>();
    private bool _loading = true;
    private bool _operationInProgress = false;
    private Vm? _currentVm;
    private string? _message;
    private bool _isError;
    private TimeSpan? _rateLimitCooldown;
    private Guid _currentUserDbId;

    protected override async Task OnInitializedAsync()
    {
        await base.OnInitializedAsync();
        await LoadVmsAsync();
        await CheckRateLimitAsync();
    }

    private async Task LoadVmsAsync()
    {
        try
        {
            if (string.IsNullOrEmpty(CurrentUserId))
            {
                _loading = false;
                return;
            }

            User? user = await Db.Users.FirstOrDefaultAsync(u => u.ExternalId == CurrentUserId);
            if (user == null)
            {
                _loading = false;
                return;
            }

            _currentUserDbId = user.Id;
            _vms = await Db.Vms
                .Where(v => v.OwnerUserId == _currentUserDbId)
                .OrderBy(v => v.Name)
                .ToListAsync();

            await LogSecurityEventAsync("VmListViewed", $"User viewed {_vms.Count} VMs", "Information");
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to load VMs for user {UserId}", CurrentUserId);
            ShowMessage("Failed to load your VMs. Please try again.", true);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task CheckRateLimitAsync()
    {
        if (!string.IsNullOrEmpty(CurrentUserId))
        {
            _rateLimitCooldown = await RateLimit.GetRemainingCooldownAsync(CurrentUserId, "vm_operations");
            StateHasChanged();
        }
    }

    private async Task<bool> CheckOperationRateLimitAsync(string operation)
    {
        if (string.IsNullOrEmpty(CurrentUserId)) return false;

        bool allowed = await RateLimit.CheckRateLimitAsync(CurrentUserId, "vm_operations", 5, TimeSpan.FromMinutes(5));
        if (!allowed)
        {
            _rateLimitCooldown = await RateLimit.GetRemainingCooldownAsync(CurrentUserId, "vm_operations");
            await LogSecurityEventAsync("RateLimitExceeded", $"Operation: {operation}", "Warning");
            ShowMessage($"Rate limit exceeded. Please wait {_rateLimitCooldown?.Minutes ?? 0} minutes.", true);
            return false;
        }

        return true;
    }

    private async Task RefreshStatusAsync(Vm vm)
    {
        if (_operationInProgress || !Sanitizer.IsValidVmId(vm.VmId))
        {
            return;
        }

        _operationInProgress = true;
        _currentVm = vm;
        StateHasChanged();

        try
        {
            VmStatus status = await Proxmox.GetVmStatusAsync(vm.Node, vm.VmId);
            vm.Status = status;
            vm.LastSyncedAt = DateTimeOffset.UtcNow;
            await Db.SaveChangesAsync();

            await LogSecurityEventAsync("VmStatusRefreshed",
                $"VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId}) Status: {status}", "Information");

            ShowMessage($"Status refreshed for {vm.Name}: {status}", false);
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to refresh VM {VmId}", vm.VmId);
            ShowMessage($"Failed to refresh status for {vm.Name}.", true);
        }
        finally
        {
            _operationInProgress = false;
            _currentVm = null;
            StateHasChanged();
        }
    }

    private async Task StartVmAsync(Vm vm)
    {
        if (!await CheckOperationRateLimitAsync("start")) return;
        await ExecuteVmOperationAsync(vm, "StartVm", Proxmox.StartVmAsync);
    }

    private async Task StopVmAsync(Vm vm)
    {
        if (!await CheckOperationRateLimitAsync("stop")) return;
        await ExecuteVmOperationAsync(vm, "StopVm", Proxmox.StopVmAsync);
    }

    private async Task ShutdownVmAsync(Vm vm)
    {
        if (!await CheckOperationRateLimitAsync("shutdown")) return;
        await ExecuteVmOperationAsync(vm, "ShutdownVm", Proxmox.ShutdownVmAsync);
    }

    private async Task ExecuteVmOperationAsync(
        Vm vm,
        string actionName,
        Func<string, int, System.Threading.CancellationToken, Task> proxmoxAction)
    {
        if (_operationInProgress || !Sanitizer.IsValidVmId(vm.VmId))
        {
            return;
        }

        string nodeName = Sanitizer.SanitizeNodeName(vm.Node);
        if (string.IsNullOrEmpty(nodeName))
        {
            ShowMessage("Invalid node name.", true);
            return;
        }

        _operationInProgress = true;
        _currentVm = vm;
        StateHasChanged();

        try
        {
            await proxmoxAction(nodeName, vm.VmId, default);
            await LogActionAsync(actionName, vm);
            ShowMessage($"{actionName} requested for {vm.Name}.", false);

            // Refresh after short delay
            _ = Task.Delay(3000).ContinueWith(async _ => await RefreshStatusAsync(vm));
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to {Action} VM {VmId}", actionName, vm.VmId);
            await LogSecurityEventAsync("VmOperationFailed",
                $"Action: {actionName}, VM: {Sanitizer.SanitizeForLog(vm.Name)} ({vm.VmId}), Error: {ex.Message}",
                "Error");
            ShowMessage($"Failed to {actionName} for {vm.Name}. Please try again.", true);
        }
        finally
        {
            _operationInProgress = false;
            _currentVm = null;
            StateHasChanged();
        }
    }

    private async Task LogActionAsync(string action, Vm vm)
    {
        try
        {
            UserAction ua = new UserAction
            {
                Id = Guid.NewGuid(),
                UserId = _currentUserDbId,
                ActionName = action,
                TargetType = "Vm",
                TargetId = $"{Sanitizer.SanitizeForLog(vm.Node)}:{vm.VmId}",
                MetadataJson = System.Text.Json.JsonSerializer.Serialize(new
                {
                    VmName = Sanitizer.SanitizeForLog(vm.Name),
                    Node = Sanitizer.SanitizeForLog(vm.Node),
                    VmId = vm.VmId
                }),
                OccurredAt = DateTimeOffset.UtcNow
            };
            Db.UserActions.Add(ua);
            await Db.SaveChangesAsync();
        }
        catch (Exception ex)
        {
            Logger.LogError(ex, "Failed to log action {Action} for VM {VmId}", action, vm.VmId);
        }
    }

    private static string GetStatusBadgeClass(VmStatus status)
    {
        return status switch
        {
            VmStatus.Running => "bg-success",
            VmStatus.Stopped => "bg-secondary",
            VmStatus.Paused => "bg-warning",
            _ => "bg-dark"
        };
    }

    private void ShowMessage(string message, bool isError)
    {
        _message = message;
        _isError = isError;
        StateHasChanged();

        _ = Task.Delay(5000).ContinueWith(_ => InvokeAsync(() =>
        {
            _message = null;
            StateHasChanged();
        }));
    }

    private void ClearMessage()
    {
        _message = null;
        StateHasChanged();
    }
}
